@using BlazorMemoApp.Models
@using System.Linq
@inject IJSRuntime JS

<br />

<div class="mb-2 d-flex flex-wrap gap-2 align-items-center">
    <div class="input-group" style="max-width:320px;">
        <span class="input-group-text">Filter</span>
        <input class="form-control form-control-sm" @bind="_filter" placeholder="Article, Color, Size, Unit" />
    </div>

    <div>
        <select class="form-select form-select-sm" style="width:90px;" @bind="_pageSize">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
        </select>
    </div>

    <button class="btn btn-sm btn-outline-primary" @onclick="SelectAllFiltered">Select All</button>
    <button class="btn btn-sm btn-danger" @onclick="DeleteSelected">Delete Selected (@_selected.Count)</button>
</div>

@if (Items is null || Items.Count == 0)
{
    <p>No details loaded. Select a PO to populate items.</p>
}
else
{
    <div style="overflow-x: auto;">
        <table class="table table-bordered table-sm align-middle">
            <thead class="table-light">
                <tr class="align-middle">
                    <th style="width:36px;"></th>
                    <th>PO</th>
                    <th>Supplier</th>
                    <th>Article</th>
                    <th>Color</th>
                    <th>Size</th>
                    <th>Price</th>
                    <th>Curency</th>
                    <th>Unit</th>
                    <th>BOM Qty</th>
                    <th>BOM Amount</th>
                    <th>Avail Stock Qty</th>
                    <th>Stock Amount</th>
                    <th>Purchase Qty</th>
                    <th>Purchase Amount</th>
                    <th>MCQ Qty</th>
                    <th>MCQ Amount</th>
                    <th>Diff</th>
                    <th>Surcharge Paid</th>
                    <th>Total Extra Paid</th>
                    <th>Stock From MCQ</th>
                    <th>Stock Usable Qty</th>
                    <th>Stock Usable Amount</th>
                    <th>Stock Non Usable Qty</th>
                    <th>Stock Non Usable Amount</th>
                    <th>Total Extra Collected</th>
                    <th>Mode Of Collect</th>
                    <th>Remark</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var it in PagedItems)
            {
                <tr>
                        <td class="text-center">
                            <div class="d-flex justify-content-center gap-1">
                                <span style="cursor: pointer;" @onclick="() => ToggleExpansion(it)">
                                    @if (_expandedRows.Contains(it))
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z" />
                                        </svg>
                                    }
                                </span>
                                <input type="checkbox" class="form-check-input" checked="@(_selected.Contains(it))" @onchange="(e) => OnRowSelectedChanged(it, e)" />
                            </div>
                        </td>
                    <td>@it.PONumber</td>
                    <td>@it.Supplier</td>
                    <td>@it.Article</td>
                    <td>@it.Color</td>
                    <td>@it.Size</td>
                    <td>@it.Price.ToString("F2")</td>
                        <td>@it.Currency</td>
                    <td>@it.Unit</td>
                    @* <td>
                            <input type="number" class="form-control form-control-sm" style="width:75px" step="0.01" @bind-value="it.BOMQty" @bind-value:event="oninput" />
                    </td> *@
                        @* MODIFIED: BOM Qty is now a display field, not an input *@
                        <td class="text-end">@it.BOMQty</td>
                        <td>@it.BOMAmount.ToString("F2")</td>
                    <td>
                            <input type="number" class="form-control form-control-sm" style="width:75px" @bind-value="it.AvailStockQty" @bind-value:event="oninput" />
                    </td>
                        <td>@it.StockAmount.ToString("F2")</td>
                        <td>@it.PurchaseQty.ToString("F2")</td>
                        <td>@it.PurchaseAmount.ToString("F2")</td>
                    <td>
                            <input type="number" class="form-control form-control-sm" style="width:75px" @bind-value="it.MCQQty" @bind-value:event="oninput" />
                    </td>
                        <td>@it.MCQAmount.ToString("F2")</td>
                        <td>@it.Diff.ToString("F2")</td>
                    <td>
                        <input type="number" step="0.01" class="form-control form-control-sm" @bind-value="it.SurchargePaid" @bind-value:event="oninput" />
                    </td>
                        <td style="width:75px">@it.TotalExtraPaid.ToString("F2")</td>
                        <td style="width:75px">@it.StockFromMCQ.ToString("F2")</td>
                    <td>
                            <input type="number" class="form-control form-control-sm" style="width:75px" @bind-value="it.StockUsableQty" @bind-value:event="oninput" />
                    </td>
                        <td>@it.StockUsableAmount.ToString("F2")</td>
                        <td>@it.StockNonUsableQty.ToString("F2")</td>
                        <td>@it.StockNonUsableAmount.ToString("F2")</td>
                    <td>
                            <input type="number" step="0.01" class="form-control form-control-sm" style="width:75px" @bind-value="it.TotalExtraCollected" @bind-value:event="oninput" />
                    </td>
                    <td>
                        <select class="form-select form-select-sm" style="width:100px" @bind="it.ModeOfCollect">
                            <option value="">-- Select --</option>
                            <option value="C">Costing</option>
                            <option value="D">DN</option>
                            <option value="F">Future Commitment</option>
                        </select>
                    </td>
                    <td>
                        <InputTextArea class="form-control form-control-sm" @bind-Value="it.Remark" rows="2" />
                    </td>
                 </tr>

                    @* NEW: Inline sub-grid for SPI and BOM Details *@
                    @if (_expandedRows.Contains(it))
                    {
                        <tr>
                            <td colspan="28" class="p-0">
                                <div class="p-3 bg-light">
                                    <h6>SPI & BOM Details for @it.Article - @it.Color - @it.Size</h6>
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>SPI Number</th>
                                                <th>Style Name</th>
                                                <th>BOM Qty</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var detail in it.SpiBomDetails)
                                            {
                                                <tr>
                                                    <td class="position-relative" style="min-width: 200px;">
                                                        <input class="form-control form-control-sm" 
                                                               value="@GetSpiSearchText(detail)"
                                                               @oninput="(e) => SetSpiSearchText(detail, e.Value?.ToString() ?? string.Empty)"
                                                               @onfocus="() => ShowSpiDropdown(detail)"
                                                               placeholder="Type to filter..." />
                                                        @if (IsSpiDropdownVisible(detail) && GetFilteredOrdersForSpi(detail).Any())
                                                        {
                                                            <div class="list-group position-absolute z-3" style="max-height:150px; overflow:auto; width:100%;">
                                                                @foreach (var order in GetFilteredOrdersForSpi(detail))
                                                                {
                                                                    <button type="button" class="list-group-item list-group-item-action py-1" @onclick="() => SelectSpiOrder(detail, order)">
                                                                        @order.OrderNo
                                                                    </button>
                                                                }
                                                            </div>
                                                        }
                                                    </td>
                                                    <td>@GetStyleNameForSpi(detail)</td>
                                                    <td style="width: 100px;">
                                                        <input type="number" class="form-control form-control-sm" @bind-value="detail.BomQty" @bind-value:event="oninput" />
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteSpiBom(it, detail)">Delete</button>
                                                    </td>
                                                </tr>
                                            }
                                            <tr>
                                                <td colspan="4">
                                                    <button class="btn btn-sm btn-primary" @onclick="() => AddSpiBom(it)">+ Add New SPI/BOM</button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    }

            }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center">
        <div>Showing @((_currentPage-1)*_pageSize+1)-@(((_currentPage-1)*_pageSize)+PagedItems.Count) of @FilteredItems.Count()</div>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item @( _currentPage==1?"disabled":"" )"><button type="button" class="page-link" @onclick="PrevPage" disabled="@(_currentPage==1)">Prev</button></li>
                @for (var p = 1; p <= TotalPages; p++)
                {
                    var page = p;
                    <li class="page-item @(p==_currentPage?"active":"")"><button type="button" class="page-link" @onclick="(()=>GotoPage(page))">@p</button></li>
                }
                <li class="page-item @(_currentPage==TotalPages?"disabled":"")"><button type="button" class="page-link" @onclick="NextPage" disabled="@(_currentPage==TotalPages)">Next</button></li>
            </ul>
        </nav>
    </div>
}

@code {
    [Parameter] public List<MemoDetailModel> Items { get; set; } = new();
    [Parameter] public EventCallback<List<MemoDetailModel>> ItemsChanged { get; set; }
    [Parameter] public int? BuyerId { get; set; }
    [Parameter] public int? StyleId { get; set; }
    [Parameter] public List<BuyerStyleOrderModel> Orders { get; set; } = new();
    // Added to accept the IsApproved flag from parent components
    [Parameter] public bool IsApproved { get; set; }

    private HashSet<MemoDetailModel> _selected = new();
    private string _filter = string.Empty;
    private int _pageSize = 10;
    private int _currentPage = 1;

    // NEW: State to track which rows are expanded (using object reference instead of Id)
    private HashSet<MemoDetailModel> _expandedRows = new();
    
    // SPI dropdown state - keyed by SpiBomDetailModel reference
    private Dictionary<SpiBomDetailModel, string> _spiSearchTexts = new();
    private Dictionary<SpiBomDetailModel, bool> _spiDropdownVisible = new();
    
    private IEnumerable<BuyerStyleOrderModel> FilteredOrders => 
        (BuyerId == null || StyleId == null)
            ? Enumerable.Empty<BuyerStyleOrderModel>()
            : Orders.Where(o => o.BuyerId == BuyerId && o.StyleId == StyleId);
    
    private IEnumerable<BuyerStyleOrderModel> GetFilteredOrdersForSpi(SpiBomDetailModel detail)
    {
        var searchText = _spiSearchTexts.GetValueOrDefault(detail, string.Empty);
        return string.IsNullOrWhiteSpace(searchText)
            ? FilteredOrders
            : FilteredOrders.Where(o => o.OrderNo.Contains(searchText, StringComparison.OrdinalIgnoreCase));
    }
    
    private string GetSpiSearchText(SpiBomDetailModel detail)
    {
        return _spiSearchTexts.GetValueOrDefault(detail, detail.SpiNo ?? string.Empty);
    }
    
    private void SetSpiSearchText(SpiBomDetailModel detail, string value)
    {
        _spiSearchTexts[detail] = value;
    }
    
    private bool IsSpiDropdownVisible(SpiBomDetailModel detail)
    {
        return _spiDropdownVisible.GetValueOrDefault(detail, false);
    }
    
    private void ShowSpiDropdown(SpiBomDetailModel detail)
    {
        _spiDropdownVisible[detail] = true;
    }
    
    private void SelectSpiOrder(SpiBomDetailModel detail, BuyerStyleOrderModel order)
    {
        detail.SpiNo = order.OrderNo;
        _spiSearchTexts[detail] = order.OrderNo;
        _spiDropdownVisible[detail] = false;
    }

    private IEnumerable<MemoDetailModel> FilteredItems => string.IsNullOrWhiteSpace(_filter)
        ? Items
        : Items.Where(i => (i.Article ?? string.Empty).Contains(_filter, StringComparison.OrdinalIgnoreCase)
                       || (i.Color ?? string.Empty).Contains(_filter, StringComparison.OrdinalIgnoreCase)
                       || (i.Size ?? string.Empty).Contains(_filter, StringComparison.OrdinalIgnoreCase)
                       || (i.Unit ?? string.Empty).Contains(_filter, StringComparison.OrdinalIgnoreCase));

    private List<MemoDetailModel> PagedItems => FilteredItems.Skip((_currentPage - 1) * _pageSize).Take(_pageSize).ToList();

    private int TotalPages => Math.Max(1, (int)Math.Ceiling(FilteredItems.Count() / (double)_pageSize));

    protected override void OnParametersSet()
    {
        // Ensure page index is valid after parameter changes
        if (_currentPage > TotalPages) _currentPage = TotalPages;
        base.OnParametersSet();
    }

    private void OnRowSelectedChanged(MemoDetailModel item, Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        var isChecked = Convert.ToBoolean(e.Value);
        if (isChecked)
            _selected.Add(item);
        else
            _selected.Remove(item);
    }

    private void SelectAllFiltered()
    {
        _selected.Clear();
        foreach (var it in FilteredItems)
            _selected.Add(it);
    }

    private async Task DeleteSelected()
    {
        if (_selected.Count == 0)
            return;

        var ok = await JS.InvokeAsync<bool>("confirm", $"Delete {_selected.Count} selected rows?");
        if (!ok)
            return;

        foreach (var s in _selected.ToList())
        {
            Items.Remove(s);
        }
        _selected.Clear();
        // adjust page if needed
        if (_currentPage > TotalPages) _currentPage = TotalPages;

        if (ItemsChanged.HasDelegate)
            await ItemsChanged.InvokeAsync(Items);
    }

    private void PrevPage()
    {
        if (_currentPage > 1) _currentPage--;
    }

    private void NextPage()
    {
        if (_currentPage < TotalPages) _currentPage++;
    }

    private void GotoPage(int p)
    {
        _currentPage = Math.Min(Math.Max(1, p), TotalPages);
    }

    // NEW: Methods for handling expansion and sub-grid actions
    private void ToggleExpansion(MemoDetailModel item)
    {
        if (_expandedRows.Contains(item))
        {
            _expandedRows.Remove(item);
        }
        else
        {
            _expandedRows.Add(item);
        }
    }

    private void AddSpiBom(MemoDetailModel parent)
    {
        // Don't set Id - let EF Core generate it on save
        parent.SpiBomDetails.Add(new SpiBomDetailModel());
    }

    private void DeleteSpiBom(MemoDetailModel parent, SpiBomDetailModel itemToDelete)
    {
        parent.SpiBomDetails.Remove(itemToDelete);
        // Blazor should re-render automatically.
    }

    // NEW: resolve StyleName from Orders by matching OrderNo == SpiNo
    private string GetStyleNameForSpi(SpiBomDetailModel detail)
    {
        if (detail == null || string.IsNullOrWhiteSpace(detail.SpiNo)) return string.Empty;
        var ord = Orders.FirstOrDefault(o => string.Equals(o.OrderNo, detail.SpiNo, StringComparison.OrdinalIgnoreCase));
        return ord?.Style?.StyleName ?? string.Empty;
    }
}