@page "/memos/{Id:int}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin,User")]
@rendermode InteractiveServer
@using BlazorMemoApp.Models
@using Microsoft.EntityFrameworkCore
@using BlazorMemoApp.Components.Memos
@using System.Security.Claims
@inject BlazorMemoApp.Data.ApplicationDbContext Db
@inject BlazorMemoApp.Services.PoApiClient PoApi
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IHttpClientFactory HttpClientFactory
@inject IWebHostEnvironment Environment
@inject BlazorMemoApp.Services.EmailService EmailService
@inject BlazorMemoApp.Services.BuyerPrivilegeService BuyerPrivilegeService

<h1>Memo @header?.MemoNo</h1>

@if (header is null)
{
    <p><em>Loading...</em></p>
}
else
{
    @if (_isApproved)
    {
        <div class="alert alert-info py-2 mb-3">
            <strong>Read-Only Mode:</strong> This memo has been approved and cannot be edited.
        </div>
    }
    <div class="row g-3">
        <div class="col-sm-2">
            <label class="form-label">Memo No</label>
            <input class="form-control" value="@header.MemoNo" disabled />
        </div>
        <div class="col-sm-2">
            <label class="form-label">Memo Date</label>
            <InputDate class="form-control" @bind-Value="header.MemoDate" disabled="@_isApproved" />
        </div>
        <div class="col-sm-2">
            <label class="form-label">Buyer</label>
            <InputSelect class="form-select" @bind-Value="header.BuyerId" disabled="@_isApproved">
                <option value="">-- Select --</option>
                @foreach (var buyer in buyers)
                {
                    <option value="@buyer.Id">@buyer.Name - @buyer.NameAbbr</option>
                }
            </InputSelect>
        </div>
        <div class="col-sm-2">
            <label class="form-label">Style</label>
            <InputSelect class="form-select" @bind-Value="header.StyleId" disabled="@(_isApproved || header.BuyerId == null)">
                <option value="">-- Select --</option>
                @foreach (var style in filteredStyles)
                {
                    <option value="@style.Id">@style.StyleName</option>
                }
            </InputSelect>
        </div>
        <div class="col-sm-2">
            <label class="form-label">Garment Qty</label>
            <InputNumber class="form-control" @bind-Value="header.GmtQty" disabled="@_isApproved" />
        </div>
        <div class="col-sm-2">
            <label class="form-label">FOB Rate</label>
            <InputNumber class="form-control" @bind-Value="header.GmtFobRate" disabled="@_isApproved" />
        </div>
        <div class="col-sm-2">
            <label class="form-label">Supplier</label>
            <InputSelect class="form-select" @bind-Value="header.SupplierId" disabled="@_isApproved">
                <option value="">-- Select --</option>
                @foreach (var supplier in suppliers)
                {
                    <option value="@supplier.Id">@supplier.Name - @supplier.NameAbbr</option>
                }
            </InputSelect>
        </div>

        <div class="col-sm-2">
            <label class="form-label">PO Selected</label>
            <input class="form-control" value="@header.PONumber" disabled />
        </div>

        <div class="col-sm-4 d-flex align-items-end flex-column">
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-info" @onclick="CalculateUsd" disabled="@_calculating">
                    @(_calculating ? "Calculating..." : "Calculate USD")
                </button>
            </div>
            @if (!string.IsNullOrEmpty(_calcMessage))
            {
                <div class="alert @(_calcSuccess ? "alert-success" : "alert-danger") alert-dismissible py-1 px-2 mt-1 mb-0" style="font-size:0.85rem;">
                    @_calcMessage
                    <button type="button" class="btn-close btn-sm" @onclick="() => _calcMessage = string.Empty"></button>
                </div>
            }
        </div>

        @if (!_isApproved)
        {
            <div class="col-sm-2 position-relative">
                <label class="form-label">Add PO Items</label>
                <div class="input-group">
                    <input class="form-control" @bind-value="SearchText" placeholder="Type part of PO No..."/>
                    <button type="button" class="btn btn-outline-primary" title="Search PO" @onclick="SearchPosAsync">Search</button>
                </div>
                @if (suggestions.Count > 0 && showSuggestions)
                {
                    <div class="list-group position-absolute z-3" style="max-height:200px; overflow:auto; width:100%;">
                        @foreach (var s in suggestions)
                        {
                            <button type="button" class="list-group-item list-group-item-action" @onclick="() => SelectPo(s)">@s</button>
                        }
                    </div>
                }
            </div>
        }
    </div>

    @* <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-sm-3"><label class="form-label">Memo No</label><div>@header.MemoNo</div></div>
                <div class="col-sm-3"><label class="form-label">Memo Date</label><div>@header.MemoDate.ToString("yyyy-MM-dd")</div></div>
                <div class="col-sm-3"><label class="form-label">PO Number</label><div>@header.PONumber</div></div>
                <div class="col-sm-3"><label class="form-label">GmtQty</label><div>@header.GmtQty</div></div>
            </div>
        </div>
    </div> *@

    <BlazorMemoApp.Components.Memos.MemoDetailGrid Items="header.Details" BuyerId="header.BuyerId" StyleId="header.StyleId" Orders="orders" IsApproved="@(header.ApproveStatus == "Approved")" />

    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0">Attachments</h5>
        </div>
        <div class="card-body">
            @if (!_isApproved)
            {
                <div class="mb-3">
                    <label class="form-label">Upload Files (max 5MB per file)</label>
                    <InputFile class="form-control" OnChange="OnFilesSelected" multiple accept="*/*" />
                </div>
                @if (!string.IsNullOrEmpty(_uploadMessage))
                {
                    <div class="alert @(_uploadSuccess ? "alert-success" : "alert-danger") alert-dismissible py-2 mb-2">
                        @_uploadMessage
                        <button type="button" class="btn-close btn-sm" @onclick="() => _uploadMessage = string.Empty"></button>
                    </div>
                }
                @if (selectedFiles.Any())
                {
                    <div class="mb-2"><strong>Selected Files:</strong></div>
                    <ul class="list-group mb-3">
                        @foreach (var file in selectedFiles)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>@file.Name (@FormatFileSize(file.Size))</span>
                                <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => RemoveSelectedFile(file)">Remove</button>
                            </li>
                        }
                    </ul>
                }
            }
            @if (header.Attachments.Any())
            {
                <div class="mb-2"><strong>Uploaded Files:</strong></div>
                <ul class="list-group">
                    @foreach (var attachment in header.Attachments)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="/uploads/memos/@attachment.StoredFileName" target="_blank">@attachment.FileName</a>
                            <span>(@FormatFileSize(attachment.FileSize))</span>
                            @if (!_isApproved)
                            {
                                <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => RemoveAttachment(attachment)">Remove</button>
                            }
                        </li>
                    }
                </ul>
            }
        </div>
    </div>

    <div class="mt-3 d-flex gap-2 align-items-center flex-wrap">
        <button class="btn btn-secondary" @onclick="Back">Back</button>
        @if ((header.ApproveStatus ?? "") != "Approved")
        {
            <button class="btn btn-primary" @onclick="Save">Save</button>
        }
        <button class="btn btn-outline-primary" @onclick="Print">Print / Save PDF</button>
        <AuthorizeView Roles="Admin,Approval">
            <Authorized>
                @if ((header.ApproveStatus ?? "") != "Approved")
                {
                    <button class="btn btn-success" title="Approve this memo" @onclick="Approve">Approve</button>
                }
                else
                {
                    <span class="badge bg-success">Approved @header.ApproveDate?.ToString("yyyy-MM-dd HH:mm")</span>
                }
            </Authorized>
        </AuthorizeView>
@*         @if ((header.ApproveStatus ?? "") != "Approved")
        {
            <button class="btn btn-danger" @onclick="Delete">Delete</button>
        } *@
    </div>
    
    @if (!string.IsNullOrEmpty(_saveMessage))
    {
        <div class="alert @(_saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show mt-2" role="alert">
            @_saveMessage
            <button type="button" class="btn-close" @onclick="() => _saveMessage = string.Empty"></button>
        </div>
    }
}

@code {
    [Parameter] public int Id { get; set; }
    private MemoHeaderModel? header;
    
    private List<MemoAdressModel> buyers = new();
    private List<MemoAdressModel> suppliers = new();
    private List<BuyerStyleModel> styles = new();
    private List<BuyerStyleOrderModel> orders = new();
    
    private bool _calculating = false;
    private string _calcMessage = string.Empty;
    private bool _calcSuccess = false;

    private string _saveMessage = string.Empty;
    private bool _saveSuccess = false;
    
    private string _uploadMessage = string.Empty;
    private bool _uploadSuccess = false;
    private List<IBrowserFile> selectedFiles = new();
    private const long MaxFileSize = 5 * 1024 * 1024; // 5MB
    
    private string searchText = string.Empty;
    private bool showSuggestions = false;
    private List<string> suggestions = new();
    
    private bool _isApproved => (header?.ApproveStatus ?? "") == "Approved";
    
    private string SearchText
    {
        get => searchText;
        set => searchText = value ?? string.Empty;
    }
    
    private IEnumerable<BuyerStyleModel> filteredStyles => 
        header?.BuyerId == null 
            ? Enumerable.Empty<BuyerStyleModel>() 
            : styles.Where(s => s.BuyerId == header.BuyerId);

    protected override async Task OnInitializedAsync()
    {
        header = await Db.Memos
            .Include(m => m.Details).ThenInclude(d => d.SpiBomDetails)
            .Include(m => m.Attachments)
            .FirstOrDefaultAsync(m => m.Id == Id);
        
        // Get current user ID for buyer privilege filtering
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        
        var allBuyers = await Db.MemoAddresses.Where(a => a.Type.Contains("B")).ToListAsync();
        buyers = !string.IsNullOrEmpty(userId) 
            ? await BuyerPrivilegeService.FilterBuyersAsync(userId, allBuyers) 
            : allBuyers;
        
        suppliers = await Db.MemoAddresses.Where(a => a.Type.Contains("V") || a.Type.Contains("F")).ToListAsync();
        styles = await Db.BuyerStyles.ToListAsync();
        orders = await Db.BuyerStyleOrders.ToListAsync();
    }

    private void Back() => Nav.NavigateTo("/memos");

    private async Task Save()
    {
        _saveMessage = string.Empty;
        _saveSuccess = false;
        
        try
        {
            await UploadFilesAsync();
            await Db.SaveChangesAsync();
            _saveMessage = $"Memo {header?.MemoNo} saved successfully.";
            _saveSuccess = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error saving memo: {ex.Message}");
            _saveMessage = $"Error saving memo: {ex.Message}";
            _saveSuccess = false;
            StateHasChanged();
        }
    }

    private async Task Print()
    {
        // Use browser print dialog; user can choose Save as PDF
        await JS.InvokeVoidAsync("window.print");
    }

    private async Task Delete()
    {
        if (header == null) return;
        var ok = await JS.InvokeAsync<bool>("confirm", $"Delete memo {header.MemoNo} and all details?");
        if (!ok) return;

        try
        {
            Db.Memos.Remove(header);
            await Db.SaveChangesAsync();
            Nav.NavigateTo("/memos");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error deleting memo: {ex.Message}");
        }
    }


    private async Task CalculateUsd()
    {
        _calculating = true;
        _calcMessage = string.Empty;
        _calcSuccess = false;
        StateHasChanged();

        try
        {
            if (header.MemoDate == default)
            {
                _calcMessage = "Please set Memo Date first.";
                _calcSuccess = false;
                return;
            }

            if (header.Details == null || !header.Details.Any())
            {
                _calcMessage = "No details to convert.";
                _calcSuccess = false;
                return;
            }

            var memoDateOnly = header.MemoDate.Date;
            var currencies = header.Details
                .Select(d => d.Currency?.Trim().ToUpper())
                .Where(c => !string.IsNullOrWhiteSpace(c) && !c.Equals("USD", StringComparison.OrdinalIgnoreCase))
                .Distinct()
                .ToList();

            if (!currencies.Any())
            {
                _calcMessage = "All currencies are already USD.";
                _calcSuccess = true;
                return;
            }

            var existingRates = await Db.PoExchangeRates
                .Where(r => currencies.Contains(r.PoCurrency)
                    && r.BaseCurrency == "USD"
                    && r.ExcDate.Date == memoDateOnly)
                .ToListAsync();

            var currenciesFromDb = existingRates.Select(r => r.PoCurrency).ToHashSet(StringComparer.OrdinalIgnoreCase);
            var currenciesToFetch = currencies.Where(c => !currenciesFromDb.Contains(c)).ToList();

            ExchangeRateResponse? response = null;
            if (currenciesToFetch.Any())
            {
                // var dateStr = header.MemoDate.ToString("yyyy-MM-dd");

                DateTime memoDate = header.MemoDate.Date;
                DateTime now = DateTime.Now;
                DateTime combined = memoDate.AddHours(now.Hour)
                            .AddMinutes(now.Minute)
                            .AddSeconds(now.Second);
                DateTime utcDate = combined.ToUniversalTime();
                var dateStr = utcDate.ToString("yyyy-MM-dd");

                var appId = "e483ad469b1142d6aaccb2f472658efd";
                var apiUrl = $"api/historical/{dateStr}.json?app_id={appId}";

                try
                {
                    var httpClient = HttpClientFactory.CreateClient("ExchangeRateApi");
                    response = await httpClient.GetFromJsonAsync<ExchangeRateResponse>(apiUrl);
                }
                catch (Exception apiEx)
                {
                    _calcMessage = $"Failed to fetch exchange rates from API: {apiEx.Message} Url {apiUrl}";
                    _calcSuccess = false;
                    return;
                }

                if (response == null || response.rates == null || !response.rates.Any())
                {
                    _calcMessage = "No exchange rates returned from API.";
                    _calcSuccess = false;
                    return;
                }
            }

            var exchangeRatesToSave = new List<PoExchangeRateModel>();
            var convertedCount = 0;
            var notFoundCurrencies = new List<string>();

            foreach (var currency in currencies)
            {
                decimal rate;
                var existingRate = existingRates.FirstOrDefault(r => r.PoCurrency.Equals(currency, StringComparison.OrdinalIgnoreCase));

                if (existingRate != null)
                {
                    rate = existingRate.ExcRate;
                }
                else if (response?.rates != null && response.rates.TryGetValue(currency, out var apiRate) && apiRate > 0)
                {
                    rate = apiRate;
                    exchangeRatesToSave.Add(new PoExchangeRateModel
                    {
                        PoCurrency = currency,
                        BaseCurrency = "USD",
                        ExcDate = header.MemoDate,
                        ExcRate = rate
                    });
                }
                else
                {
                    notFoundCurrencies.Add(currency);
                    continue;
                }

                var usdRate = 1m / rate;
                foreach (var detail in header.Details.Where(d =>
                    !string.IsNullOrWhiteSpace(d.Currency) &&
                    d.Currency.Trim().Equals(currency, StringComparison.OrdinalIgnoreCase)))
                {
                    detail.Price = Math.Round(detail.Price * usdRate, 6);
                    detail.Currency = "USD";
                    convertedCount++;
                }
            }

            if (exchangeRatesToSave.Any())
            {
                Db.PoExchangeRates.AddRange(exchangeRatesToSave);
                await Db.SaveChangesAsync();
            }

            if (notFoundCurrencies.Any())
            {
                _calcMessage = $"Converted {convertedCount} items. Rate not found for: {string.Join(", ", notFoundCurrencies)}";
                _calcSuccess = convertedCount > 0;
            }
            else if (convertedCount > 0)
            {
                _calcMessage = $"Successfully converted {convertedCount} item(s) to USD.";
                _calcSuccess = true;
            }
            else
            {
                _calcMessage = "No items were converted.";
                _calcSuccess = false;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            _calcMessage = $"Error: {ex.Message}";
            _calcSuccess = false;
            Console.Error.WriteLine($"Error calculating USD: {ex.Message}");
        }
        finally
        {
            _calculating = false;
            StateHasChanged();
        }
    }

    public class ExchangeRateResponse
    {
        public string? disclaimer { get; set; }
        public string? license { get; set; }
        public long timestamp { get; set; }
        public string? @base { get; set; }
        public Dictionary<string, decimal> rates { get; set; } = new();
    }

    private async Task Approve()
    {
        if (header == null) return;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user?.Identity?.IsAuthenticated != true) return;
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        try
        {
            header.ApproveStatus = "Approved";
            header.ApproveUserId = userId;
            header.ApproveDate = DateTime.UtcNow;

            await Db.SaveChangesAsync();
            
            // Send email notification to creator
            if (!string.IsNullOrEmpty(header.CreatedByEmail))
            {
                await EmailService.SendMemoApprovalNotificationAsync(header, header.CreatedByEmail);
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error approving memo: {ex.Message}");
        }
    }

    private async Task SearchPosAsync()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            suggestions.Clear();
            showSuggestions = false;
            StateHasChanged();
            return;
        }
        suggestions = await PoApi.SearchPosAsync(searchText);
        showSuggestions = suggestions.Count > 0;
        StateHasChanged();
    }

    private async Task SelectPo(string po)
    {
        if (header == null) return;
        
        header.PONumber = po;
        showSuggestions = false;
        suggestions.Clear();
        searchText = po;

        var details = await PoApi.GetPoDetailsAsync(po);
        var supplierName = header.SupplierId > 0 
            ? suppliers.FirstOrDefault(s => s.Id == header.SupplierId)?.Name ?? string.Empty
            : string.Empty;
            
        var newItems = details.Select(d => new MemoDetailModel
        {
            Article = d.Article,
            Color = d.Color,
            Size = d.Spec_Value,
            Price = d.Rate,
            Currency = d.Currency,
            Unit = d.Uom_Po,
            PONumber = po,
            ItemCode = d.Custom1,
            Supplier = supplierName
        }).ToList();
        
        header.Details ??= new List<MemoDetailModel>();
        header.Details.AddRange(newItems);

        StateHasChanged();
    }

    private void OnFilesSelected(InputFileChangeEventArgs e)
    {
        _uploadMessage = string.Empty;
        var invalidFiles = new List<string>();
        
        foreach (var file in e.GetMultipleFiles(100))
        {
            if (file.Size > MaxFileSize)
            {
                invalidFiles.Add($"{file.Name} ({FormatFileSize(file.Size)})");
            }
            else if (!selectedFiles.Any(f => f.Name == file.Name))
            {
                selectedFiles.Add(file);
            }
        }
        
        if (invalidFiles.Any())
        {
            _uploadMessage = $"Files exceeding 5MB limit: {string.Join(", ", invalidFiles)}";
            _uploadSuccess = false;
        }
        
        StateHasChanged();
    }

    private void RemoveSelectedFile(IBrowserFile file)
    {
        selectedFiles.Remove(file);
        StateHasChanged();
    }

    private void RemoveAttachment(MemoAttachmentModel attachment)
    {
        if (header == null) return;
        header.Attachments.Remove(attachment);
        StateHasChanged();
    }

    private static string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / (1024.0 * 1024.0):F2} MB";
    }

    private async Task UploadFilesAsync()
    {
        if (header == null || !selectedFiles.Any()) return;
        
        var uploadPath = Path.Combine(Environment.WebRootPath, "uploads", "memos");
        Directory.CreateDirectory(uploadPath);
        
        foreach (var file in selectedFiles)
        {
            try
            {
                var storedFileName = $"{Guid.NewGuid()}_{file.Name}";
                var filePath = Path.Combine(uploadPath, storedFileName);
                
                await using var stream = file.OpenReadStream(MaxFileSize);
                await using var fileStream = new FileStream(filePath, FileMode.Create);
                await stream.CopyToAsync(fileStream);
                
                header.Attachments.Add(new MemoAttachmentModel
                {
                    FileName = file.Name,
                    StoredFileName = storedFileName,
                    ContentType = file.ContentType,
                    FileSize = file.Size,
                    UploadedAt = DateTime.UtcNow
                });
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Error uploading file {file.Name}: {ex.Message}");
            }
        }
        
        selectedFiles.Clear();
    }
}
