@page "/memos"
@page "/memos/approval"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject BlazorMemoApp.Data.ApplicationDbContext Db
@inject IJSRuntime JS

@using BlazorMemoApp.Models
@using Microsoft.EntityFrameworkCore
@using System.Text
@using System.Globalization
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject BlazorMemoApp.Services.EmailService EmailService
@inject BlazorMemoApp.Services.BuyerPrivilegeService BuyerPrivilegeService

<h1>Memo List</h1>

@if (_approvalMode)
{
    <div class="alert alert-info py-2">Approval Mode — select a memo and/or approve inline. Showing Pending only.</div>
}

<div class="mb-3 d-flex gap-2 flex-wrap align-items-center">
    @if (!_approvalMode)
    {
        <AuthorizeView Roles="Admin,User">
            <Authorized>
                <button class="btn btn-primary" @onclick="CreateNew">Create Memo</button>
            </Authorized>
        </AuthorizeView>
    }

    <div class="input-group" style="max-width:340px;">
        <span class="input-group-text">Search</span>
        <input class="form-control form-control-sm" @bind="_filter" placeholder="Memo No, PO Number" />
    </div>

    <div>
        <select class="form-select form-select-sm" style="width:90px;" @bind="_pageSize">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
        </select>
    </div>
</div>

@if (_allMemos is null)
{
    <p><em>Loading...</em></p>
}
else if (!_allMemos.Any())
{
    <p>No memos found.</p>
}
else
{
    <div class="memo-table-wrap" style="overflow-x:auto;">
        <table class="table table-sm table-bordered align-middle memo-table" style="min-width: max-content;">
            <thead class="table-light">
                <tr>
                    <th class="align-middle">Memo No</th>
                    <th class="align-middle">Memo Date</th>
                    <th class="align-middle">Buyer Name</th>
                    <th class="align-middle">PO Number</th>
                    <th class="align-middle text-md-center" style="width:100px;">Qty<br />(Gmt)</th>
                    <th class="align-middle">Fob Value</th>
                    <th class="align-middle text-md-center" style="width:120px;">Surcharge<br />Paid (sum)</th>
                    <th class="align-middle text-md-center" style="width:120px;">Collected<br />(sum)</th>
                    <th class="align-middle text-md-center" style="width:120px;">Paid<br />(sum)</th>
                    <th class="align-middle">Approval Status</th>
                    <th class="align-middle">Approved By</th>
                    <th class="align-middle">Approved Date</th>
                    <th class="align-middle  text-md-center" style="width:280px;">Actions</th>
                </tr>
            </thead>
            <tbody>

            @foreach (var memo in PagedMemos)
            {
                <tr>
                    <td>@memo.MemoNo</td>
                    <td>@memo.MemoDate.ToString("yyyy-MM-dd")</td>
                    <td>@(memo.Buyer != null ? $"{memo.Buyer.Name} - {memo.Buyer.NameAbbr}" : "")</td>
                    <td>@memo.PONumber</td>
                    <td>@memo.GmtQty</td>
                    <td>@(memo.CalcFobValue.ToString("N2") ?? "")</td>
                    <td class="text-end">@memo.Details?.Sum(d => d.SurchargePaid).ToString("N2")</td>
                    <td class="text-end">@memo.Details?.Sum(d => d.TotalExtraCollected).ToString("N2")</td>
                    <td class="text-end">@GetTotalExtraPaid(memo.Id).ToString("N2")</td>
                    <td>@(memo.ApproveStatus)</td>
                    <td>@(memo.ApproveUser?.UserName)</td>
                    <td>@(memo.ApproveDate?.ToString("yyyy-MM-dd HH:mm") ?? "")</td>
                    <td>
                        <div class="d-flex gap-2 flex-wrap">
                            @if (_approvalMode)
                            {
                                <button class="btn btn-sm btn-outline-primary" title="Open" @onclick="() => ViewMemo(memo.Id)">Select</button>
                                <AuthorizeView Roles="Admin,Approval">
                                    <Authorized>
                                        @if ((memo.ApproveStatus ?? "") != "Approved")
                                        {
                                            <button class="btn btn-sm btn-success" @onclick="() => ApproveMemo(memo.Id)">Approve</button>
                                        }
                                    </Authorized>
                                </AuthorizeView>
                            }
                            else
                            {
                                @if (_isAcct)
                                {
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => ViewMemo(memo.Id)">View/Print</button>
                                    <button class="btn btn-sm btn-outline-success" @onclick="() => ExportCsv(memo.Id)">CSV</button>
                                }
                                else
                                {
                                    @if ((memo.ApproveStatus ?? "") != "Approved")
                                    {
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => EditMemo(memo.Id)">Edit</button>
                                    }
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => ViewMemo(memo.Id)">View/Print</button>
                                    <button class="btn btn-sm btn-outline-success" @onclick="() => ExportCsv(memo.Id)">CSV</button>
                                    @if ((memo.ApproveStatus ?? "") != "Approved")
                                    {
                                        @if (_isAdmin || _isSupervisor)
                                        {
                                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteMemo(memo.Id)">Delete</button>
                                        }
                                    }
                                }
                            }
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center">
        <div>Showing @((_currentPage-1)*_pageSize+1)-@(((_currentPage-1)*_pageSize)+PagedMemos.Count()) of @FilteredMemos.Count()</div>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item @(_currentPage==1?"disabled":"")"><button type="button" class="page-link" @onclick="PrevPage" disabled="@(_currentPage==1)">Prev</button></li>
                @for (var p = 1; p <= TotalPages; p++)
                {
                    var page = p;
                    <li class="page-item @(p==_currentPage?"active":"")"><button type="button" class="page-link" @onclick="(()=>GotoPage(page))">@p</button></li>
                }
                <li class="page-item @(_currentPage==TotalPages?"disabled":"")"><button type="button" class="page-link" @onclick="NextPage" disabled="@(_currentPage==TotalPages)">Next</button></li>
            </ul>
        </nav>
    </div>
}

@code {
    private List<MemoHeaderModel>? _allMemos;
    private string _filter = string.Empty;
    private int _pageSize = 10;
    private int _currentPage = 1;
    private bool _approvalMode = false;
    private bool _isAdmin = false;
    private bool _isSupervisor = false;
    private bool _isAcct = false;

    private IEnumerable<MemoHeaderModel> FilteredMemos
        => (_allMemos ?? Enumerable.Empty<MemoHeaderModel>())
            .Where(m => string.IsNullOrWhiteSpace(_filter)
                        || (m.MemoNo ?? string.Empty).Contains(_filter, StringComparison.OrdinalIgnoreCase)
                        || (m.PONumber ?? string.Empty).Contains(_filter, StringComparison.OrdinalIgnoreCase))
            .Where(m => !_approvalMode || string.Equals(m.ApproveStatus ?? "", "Pending", StringComparison.OrdinalIgnoreCase))
            .Where(m => !_isAcct || string.Equals(m.ApproveStatus ?? "", "Approved", StringComparison.OrdinalIgnoreCase));

    private IEnumerable<MemoHeaderModel> PagedMemos => FilteredMemos.Skip((_currentPage - 1) * _pageSize).Take(_pageSize);

    private int TotalPages => Math.Max(1, (int)Math.Ceiling(FilteredMemos.Count() / (double)_pageSize));

    protected override async Task OnInitializedAsync()
    {
        UpdateMode();
        
        // Get current user ID for buyer privilege filtering
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user?.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        
        _isAdmin = authState.User.IsInRole("Admin");
        _isSupervisor = authState.User.IsInRole("Supervisor");
        _isAcct = authState.User.IsInRole("Acct");

        // Get allowed buyer IDs for current user
        var hasAllAccess = !string.IsNullOrEmpty(userId) && await BuyerPrivilegeService.HasAllBuyersAccessAsync(userId);
        var allowedBuyerIds = !string.IsNullOrEmpty(userId) 
            ? await BuyerPrivilegeService.GetAllowedBuyerIdsAsync(userId) 
            : new List<int>();
        
        // Load memos filtered by buyer privilege
        var query = Db.Memos.Include(m => m.ApproveUser).AsQueryable();
        
        if (!hasAllAccess && allowedBuyerIds.Count > 0)
        {
            query = query.Where(m => m.BuyerId == null || allowedBuyerIds.Contains(m.BuyerId.Value));
        }
        else if (!hasAllAccess && allowedBuyerIds.Count == 0 && !string.IsNullOrEmpty(userId))
        {
            // User has no privileges - show no data
            query = query.Where(m => false);
        }

        if (_isAcct)
        {
            query = query.Where(m => (m.ApproveStatus ?? string.Empty).ToUpper() == "APPROVED");
        }
        
        // Always eager-load Details for correct sum
        _allMemos = await query
            .Include(m => m.Details)
            .OrderByDescending(m => m.MemoDate)
            .ToListAsync();

        if (_currentPage > TotalPages) _currentPage = TotalPages;

        if (_approvalMode)
        {
            // Non-authorized users should not access approval mode; redirect to regular list
            if (!(user?.IsInRole("Admin") == true || user?.IsInRole("Approval") == true))
            {
                Nav.NavigateTo("/memos", forceLoad: false);
            }
        }
    }

    protected override void OnParametersSet()
    {
        UpdateMode();
    }

    private void UpdateMode()
    {
        var path = Nav.ToBaseRelativePath(Nav.Uri);
        _approvalMode = path.StartsWith("memos/approval", StringComparison.OrdinalIgnoreCase);
    }

    // Always fetch fresh details from DB for correct sum
    private decimal GetTotalExtraPaid(int memoId)
    {
        var details = Db.MemoDetails.Where(d => d.MemoHeaderId == memoId).Select(d => d.TotalExtraPaid).ToList();
        return details.Sum();
    }

    private async Task ApproveMemo(int id)
    {
        // Only Supervisor/Admin should reach here due to UI guard
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user?.Identity?.IsAuthenticated != true) return;
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        var memo = _allMemos?.FirstOrDefault(m => m.Id == id);
        if (memo == null) return;

        memo.ApproveStatus = "Approved";
        memo.ApproveUserId = userId;
        memo.ApproveDate = DateTime.UtcNow;

        try
        {
            await Db.SaveChangesAsync();
            
            // Send email notification to creator
            if (!string.IsNullOrEmpty(memo.CreatedByEmail))
            {
                await EmailService.SendMemoApprovalNotificationAsync(memo, memo.CreatedByEmail);
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error approving memo: {ex.Message}");
        }
    }

    private void CreateNew()
    {
        Nav.NavigateTo("/memos/new");
    }

    private void EditMemo(int id)
    {
        Nav.NavigateTo($"/memos/{id}");
    }

    private void ViewMemo(int id)
    {
        Nav.NavigateTo($"/memos/{id}");
    }

    private async Task DeleteMemo(int id)
    {
        var memo = _allMemos?.FirstOrDefault(m => m.Id == id);
        if (memo == null)
            return;

        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Delete memo {memo.MemoNo}? This will remove its details as well.");
        if (!confirmed)
            return;

        try
        {
            Db.Memos.Remove(memo);
            await Db.SaveChangesAsync();
            _allMemos?.Remove(memo);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error deleting memo: {ex.Message}");
        }
    }

    private async Task ExportCsv(int id)
    {
        var memo = _allMemos?.FirstOrDefault(m => m.Id == id);
        if (memo == null) return;

        var sb = new StringBuilder();
        // Header info (key,value)
        sb.AppendLine("Field,Value");
        sb.AppendLine($"Buyer,{EscapeCsv(memo.Buyer?.Name ?? "")}");
        sb.AppendLine($"MemoNo,{EscapeCsv(memo.MemoNo)}");
        sb.AppendLine($"MemoDate,{memo.MemoDate.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture)}");
        sb.AppendLine($"GmtQty,{memo.GmtQty}");
        sb.AppendLine($"FobValue,{memo.CalcFobValue.ToString("F2", CultureInfo.InvariantCulture) ?? string.Empty}");
        sb.AppendLine($"ApproveStatus,{EscapeCsv(memo.ApproveStatus)}");
        sb.AppendLine($"ApproveUserId,{EscapeCsv(memo.ApproveUser?.UserName)}");
        sb.AppendLine($"ApproveDate,{(memo.ApproveDate?.ToString("yyyy-MM-dd HH:mm", CultureInfo.InvariantCulture) ?? string.Empty)}");        
        sb.AppendLine();

        // Details header
        sb.AppendLine("PONo, Article,Color,Size,Price,Unit,Supplier,BOMQty,AvailStockQty,MCQQty,SurchargePaid,StockUsableQty,TotalExtraCollected,BOMAmount,StockAmount,PurchaseQty,PurchaseAmount,MCQAmount,Diff,StockFromMCQ,StockUsableAmount,StockNonUsableQty,StockNonUsableAmount,TotalExtraPaid, Remark");

        foreach (var d in memo.Details ?? Enumerable.Empty<MemoDetailModel>())
        {
            var line = string.Join(",",                   
                EscapeCsv(d.PONumber),                
                EscapeCsv(d.Article),
                EscapeCsv(d.Color),
                EscapeCsv(d.Size),
                d.Price.ToString("F2", CultureInfo.InvariantCulture),
                EscapeCsv(d.Unit),
                EscapeCsv(d.Supplier),
                d.BOMQty.ToString(CultureInfo.InvariantCulture),
                d.AvailStockQty.ToString(CultureInfo.InvariantCulture),
                d.MCQQty.ToString(CultureInfo.InvariantCulture),
                d.SurchargePaid.ToString("F2", CultureInfo.InvariantCulture),
                d.StockUsableQty.ToString(CultureInfo.InvariantCulture),
                d.TotalExtraCollected.ToString("F2", CultureInfo.InvariantCulture),
                d.BOMAmount.ToString("F2", CultureInfo.InvariantCulture),
                d.StockAmount.ToString("F2", CultureInfo.InvariantCulture),
                d.PurchaseQty.ToString(CultureInfo.InvariantCulture),
                d.PurchaseAmount.ToString("F2", CultureInfo.InvariantCulture),
                d.MCQAmount.ToString("F2", CultureInfo.InvariantCulture),
                d.Diff.ToString("F2", CultureInfo.InvariantCulture),
                d.StockFromMCQ.ToString(CultureInfo.InvariantCulture),
                d.StockUsableAmount.ToString("F2", CultureInfo.InvariantCulture),
                d.StockNonUsableQty.ToString(CultureInfo.InvariantCulture),
                d.StockNonUsableAmount.ToString("F2", CultureInfo.InvariantCulture),
                d.TotalExtraPaid.ToString("F2", CultureInfo.InvariantCulture),
                EscapeCsv(d.Remark)
            );
            sb.AppendLine(line);
        }

        var csv = sb.ToString();
        var bytes = Encoding.UTF8.GetBytes(csv);
        var base64 = Convert.ToBase64String(bytes);
        var filename = $"{(string.IsNullOrWhiteSpace(memo.MemoNo) ? "memo" : memo.MemoNo)}_{memo.Id}.csv".Replace("\"", "");

        // Use a small inline script to trigger download from base64 data
        var safeBase64 = base64.Replace("'", "\\'");
        var safeFilename = filename.Replace("'", "\\'");
        var js = $"(function(b64, filename){{var link=document.createElement('a');link.href='data:text/csv;base64,'+b64;link.download=filename;document.body.appendChild(link);link.click();document.body.removeChild(link);}})('{safeBase64}','{safeFilename}');";
        await JS.InvokeVoidAsync("eval", js);
    }

    private static string EscapeCsv(string? input)
    {
        if (string.IsNullOrEmpty(input)) return string.Empty;
        var needQuotes = input.Contains(',') || input.Contains('"') || input.Contains('\r') || input.Contains('\n');
        var outVal = input.Replace("\"", "\"\"");
        return needQuotes ? '"' + outVal + '"' : outVal;
    }

    private void PrevPage()
    {
        if (_currentPage > 1) _currentPage--;
    }

    private void NextPage()
    {
        if (_currentPage < TotalPages) _currentPage++;
    }

    private void GotoPage(int p)
    {
        _currentPage = Math.Min(Math.Max(1, p), TotalPages);
    }
}
