@page "/memos/new"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin,User")]
@rendermode InteractiveServer
@using BlazorMemoApp.Models
@using System.Security.Claims
@using Microsoft.EntityFrameworkCore
@inject BlazorMemoApp.Services.PoApiClient PoApi
@inject NavigationManager Nav
@inject BlazorMemoApp.Data.ApplicationDbContext Db
@inject AuthenticationStateProvider AuthenticationStateProvider


<h1>Create Memo</h1>
<hr />

<EditForm Model="header">
    <div class="row g-3">
@*         <AuthorizeView Roles="Admin,Supervisor">
            <Authorized Context="auth">
        @if ((header.ApproveStatus ?? "") != "Approved")
        {
            <button class="btn btn-success" title="Approve this memo" @onclick="Approve">Approve</button>
        }
        else
        {
            <span class="badge bg-success">Approved @header.ApproveDate?.ToString("yyyy-MM-dd HH:mm")</span>
        }
            </Authorized>
        </AuthorizeView> *@
        <div class="col-sm-2">
            <label class="form-label">Memo No</label>
            <input class="form-control" value="@header.MemoNo" disabled/>
        </div>
        <div class="col-sm-2">
            <label class="form-label">Memo Date</label>
            <InputDate class="form-control" @bind-Value="header.MemoDate"/>
        </div>
        <div class="col-sm-2 position-relative">
            <label class="form-label">Buyer</label>
            <input class="form-control" 
                   @bind-value="buyerSearchText" 
                   @bind-value:event="oninput"
                   @onfocus="() => showBuyerDropdown = true"
                   placeholder="Type to filter..." />
            @if (showBuyerDropdown && filteredBuyers.Any())
            {
                <div class="list-group position-absolute z-3" style="max-height:200px; overflow:auto; width:100%;">
                    @foreach (var buyer in filteredBuyers)
                    {
                        <button type="button" class="list-group-item list-group-item-action" @onclick="() => SelectBuyer(buyer)">
                            @buyer.Name - @buyer.NameAbbr
                        </button>
                    }
                </div>
            }
        </div>
        <div class="col-sm-2">
            <label class="form-label">Style</label>
            <InputSelect class="form-select" @bind-Value="header.StyleId" disabled="@(header.BuyerId == null)">
                <option value="">-- Select --</option>
                @foreach (var style in filteredStyles)
                {
                    <option value="@style.Id">@style.StyleName</option>
                }
            </InputSelect>
        </div>
        <div class="col-sm-2">
            <label class="form-label">Garment Qty</label>
            <InputNumber class="form-control" @bind-Value="header.GmtQty"/>
        </div>
        <div class="col-sm-2">
            <label class="form-label">FOB Value</label>
            <InputNumber class="form-control" @bind-Value="header.GmtFobValue" />
        </div>
        <div class="col-sm-2 position-relative">
            <label class="form-label">Supplier</label>
            <input class="form-control" 
                   @bind-value="supplierSearchText" 
                   @bind-value:event="oninput"
                   @onfocus="() => showSupplierDropdown = true"
                   placeholder="Type to filter..." />
            @if (showSupplierDropdown && filteredSuppliers.Any())
            {
                <div class="list-group position-absolute z-3" style="max-height:200px; overflow:auto; width:100%;">
                    @foreach (var supplier in filteredSuppliers)
                    {
                        <button type="button" class="list-group-item list-group-item-action" @onclick="() => SelectSupplier(supplier)">
                            @supplier.Name - @supplier.NameAbbr
                        </button>
                    }
                </div>
            }
        </div>
        <div class="col-sm-2 position-relative">
            <label class="form-label">PO Number</label>
            <div class="input-group">
                @* <input class="form-control" @bind-value="SearchText" @bind-value:event="oninput" placeholder="Type part of PO No..." /> *@
                <input class="form-control" @bind-value="SearchText" placeholder="Type part of PO No..."/>
                <button type="button" class="btn btn-outline-primary" title="Search PO" @onclick="SearchPosAsync">Search PO</button>
            </div>
            @if (suggestions.Count > 0 && showSuggestions)
            {
                <div class="list-group position-absolute z-3" style="max-height:200px; overflow:auto; width:100%;">
                    @foreach (var s in suggestions)
                    {
                        <button type="button" class="list-group-item list-group-item-action" @onclick="() => SelectPo(s)">@s</button>
                    }
                </div>
            }
        </div>
        <div class="col-sm-2">
            <label class="form-label">PO Selected</label>
            <input class="form-control" value="@header.PONumber" disabled/>
        </div>
    </div>
</EditForm>

<hr />

<BlazorMemoApp.Components.Memos.MemoDetailGrid Items="header.Details" />

<div class="mt-3 d-flex gap-2 align-items-center flex-wrap">
    <button class="btn btn-secondary" @onclick="Cancel">Cancel</button>
    <button class="btn btn-primary" @onclick="Save">Save</button>

    <AuthorizeView Roles="Admin,Supervisor">
        <Authorized>
            @if ((header.ApproveStatus ?? "") != "Approved")
            {
                <button class="btn btn-success" title="Approve this memo" @onclick="Approve">Approve</button>
            }
            else
            {
                <span class="badge bg-success">Approved @header.ApproveDate?.ToString("yyyy-MM-dd HH:mm")</span>
            }
        </Authorized>
    </AuthorizeView>
</div>

@code {
    private MemoHeaderModel header = new()
    {
        MemoNo = GenerateMemoNo()
    };

    private string searchText = string.Empty;
    private bool showSuggestions = false;
    private List<string> suggestions = new();
    private System.Timers.Timer? debounceTimer;
    
    private List<MemoAdressModel> buyers = new();
    private List<MemoAdressModel> suppliers = new();
    private List<BuyerStyleModel> styles = new();
    
    private IEnumerable<BuyerStyleModel> filteredStyles => 
        header.BuyerId == null 
            ? Enumerable.Empty<BuyerStyleModel>() 
            : styles.Where(s => s.BuyerId == header.BuyerId);
    
    private string buyerSearchText = string.Empty;
    private bool showBuyerDropdown = false;
    
    private IEnumerable<MemoAdressModel> filteredBuyers => 
        string.IsNullOrWhiteSpace(buyerSearchText)
            ? buyers
            : buyers.Where(b => 
                (b.Name?.Contains(buyerSearchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (b.NameAbbr?.Contains(buyerSearchText, StringComparison.OrdinalIgnoreCase) ?? false));
    
    private string supplierSearchText = string.Empty;
    private bool showSupplierDropdown = false;
    
    private IEnumerable<MemoAdressModel> filteredSuppliers => 
        string.IsNullOrWhiteSpace(supplierSearchText)
            ? suppliers
            : suppliers.Where(s => 
                (s.Name?.Contains(supplierSearchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (s.NameAbbr?.Contains(supplierSearchText, StringComparison.OrdinalIgnoreCase) ?? false));

    private string SearchText
    {
        get => searchText;
        set
        {
            searchText = value ?? string.Empty;
            debounceTimer?.Stop();
            debounceTimer?.Start();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        debounceTimer = new System.Timers.Timer(300);
        debounceTimer.AutoReset = false;
        debounceTimer.Elapsed += async (_, _) => await InvokeAsync(SearchPosAsync);
        
        buyers = await Db.MemoAddresses.Where(a => a.Type.Contains("B")).ToListAsync();
        suppliers = await Db.MemoAddresses.Where(a => a.Type.Contains("V") || a.Type.Contains("F")).ToListAsync();
        styles = await Db.BuyerStyles.ToListAsync();
    }

    private static string GenerateMemoNo()
    {
        // Placeholder auto-generated memo no
        return $"MO{DateTime.UtcNow:yyMMddHHmmss}";
    }

    private async Task SearchPosAsync()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            suggestions.Clear();
            showSuggestions = false;
            StateHasChanged();
            return;
        }
        suggestions = await PoApi.SearchPosAsync(searchText);
        showSuggestions = suggestions.Count > 0;
        StateHasChanged();
    }

    private void OnSearchInput(Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? string.Empty;
        debounceTimer?.Stop();
        debounceTimer?.Start();
    }

    private async Task SelectPo(string po)
    {
        header.PONumber = po;
        showSuggestions = false;
        suggestions.Clear();
        searchText = po;

        var details = await PoApi.GetPoDetailsAsync(po);
        var newItems = details.Select(d => new MemoDetailModel
        {
            Article = d.Article,
            Color = d.Color,
            Size = d.Spec_Value,
            Price = d.Rate,
            Currency = d.Currency,
            Unit = d.Uom_Po,
            PONumber = po,
            ItemCode = d.Custom1
        }).ToList();
        
        // Append new items to existing list instead of replacing
        header.Details ??= new List<MemoDetailModel>();
        header.Details.AddRange(newItems);

        // Trigger re-render grid
        StateHasChanged();
    }

    private void SelectBuyer(MemoAdressModel buyer)
    {
        header.BuyerId = buyer.Id;
        header.StyleId = null;
        buyerSearchText = $"{buyer.Name} - {buyer.NameAbbr}";
        showBuyerDropdown = false;
        Console.WriteLine($"Selected Buyer: Id={buyer.Id}, Name={buyer.Name}");
    }

    private void SelectSupplier(MemoAdressModel supplier)
    {
        header.SupplierId = supplier.Id;
        supplierSearchText = $"{supplier.Name} - {supplier.NameAbbr}";
        showSupplierDropdown = false;
    }

    private void Cancel() => Nav.NavigateTo("/memos");

private async Task Save()
{
    if (
        string.IsNullOrWhiteSpace(header.PONumber) ||
        header.MemoDate == default ||
        header.Details == null || !header.Details.Any())
    {
        return;
    }

    try
    {
        Console.WriteLine($"Saving Memo - BuyerId: {header.BuyerId}, SupplierId: {header.SupplierId}, StyleId: {header.StyleId}");
        
        Db.Memos.Add(header);
        await Db.SaveChangesAsync();
        
        Console.WriteLine($"Saved Memo - Id: {header.Id}");

        Nav.NavigateTo("/memos");
    }
    catch (Exception ex)
    {
        Console.Error.WriteLine($"Error saving memo: {ex.Message}");
    }
}

private async Task Approve()
{
    var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
    var user = authState.User;
    if (user?.Identity?.IsAuthenticated != true) return;
    
    var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

    Console.WriteLine($"Approve - UserId from NameIdentifier: {userId}");
    Console.WriteLine($"Approve - User.Identity.Name: {user.Identity?.Name}");
    
    if (string.IsNullOrEmpty(userId))
    {
        Console.WriteLine("Warning: UserId is null or empty!");
        return;
    }

    if (string.IsNullOrWhiteSpace(header.PONumber) || header.MemoDate == default || header.Details == null || !header.Details.Any())
    {
        return;
    }

    try
    {
        if (header.Id == 0)
        {
            Db.Memos.Add(header);
            await Db.SaveChangesAsync();
        }

        header.ApproveStatus = "Approved";
        header.ApproveUserId = userId;
        header.ApproveDate = DateTime.UtcNow;
        
        Console.WriteLine($"Saving Approval - ApproveUserId: {header.ApproveUserId}, ApproveDate: {header.ApproveDate}");

        await Db.SaveChangesAsync();
        Nav.NavigateTo("/memos/approval");
    }
    catch (Exception ex)
    {
        Console.Error.WriteLine($"Error approving memo: {ex.Message}");
    }
}
}
