@page "/reports/summary"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@rendermode InteractiveServer
@using BlazorMemoApp.Models
@using BlazorMemoApp.Data
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject ApplicationDbContext Db
@inject BlazorMemoApp.Services.BuyerPrivilegeService BuyerPrivilegeService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS
@inject NavigationManager Nav

<h1>Report Summary</h1>
<p class="text-muted">Memo details summary report</p>

<div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
    <div class="input-group" style="max-width:300px;">
        <span class="input-group-text">Search</span>
        <input class="form-control" @bind="_searchText" @bind:event="oninput" placeholder="Buyer, Memo#, Style..." />
    </div>
    
    <div class="input-group" style="max-width:200px;">
        <span class="input-group-text">From</span>
        <input type="date" class="form-control" @bind="_dateFrom" />
    </div>
    
    <div class="input-group" style="max-width:200px;">
        <span class="input-group-text">To</span>
        <input type="date" class="form-control" @bind="_dateTo" />
    </div>
    
    <div class="input-group" style="max-width:200px;">
        <span class="input-group-text">Status</span>
        <select class="form-select" @bind="_approvalStatusFilter">
            <option value="">All</option>
            <option value="Pending">Pending</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
        </select>
    </div>
    
    <button class="btn btn-primary" @onclick="LoadData">Apply Filter</button>
    <button class="btn btn-outline-secondary" @onclick="ClearFilter">Clear</button>
    
    <div class="ms-auto d-flex gap-2">
        <button class="btn btn-success" @onclick="ExportExcel">Export Excel</button>
        <button class="btn btn-danger" @onclick="ExportPdf">Export PDF</button>
    </div>
</div>

<div class="mb-2">
    <select class="form-select form-select-sm" style="width:100px;" @bind="_pageSize" @bind:after="OnPageSizeChanged">
        <option value="10">10</option>
        <option value="25">25</option>
        <option value="50">50</option>
        <option value="100">100</option>
    </select>
</div>

@if (_loading)
{
    <p><em>Loading...</em></p>
}
else if (_data.Count == 0)
{
    <div class="alert alert-info">No data found.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped table-sm">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Buyer</th>
                    <th>Memo #</th>
                    <th>Memo Date</th>
                    <th>Style</th>
                    <th class="text-end">Gmt Qty</th>
                    <th class="text-end">Gmt FOB Value</th>
                    <th class="text-end">Surcharge Paid</th>
                    <th class="text-end">Stock Usable Amount</th>
                    <th class="text-end">Stock Non-Usable Amount</th>
                    <th class="text-end">Total Extra Paid</th>
                    <th class="text-end">Amount Costing</th>
                    <th class="text-end">Amount DN</th>
                    <th class="text-end">Saving</th>
                    <th class="text-end">Amount Commitment</th>
                    <th class="text-end">Percent Of Fob Value</th>
                    <th>User Name</th>
                    <th>Approval Status</th>
                </tr>
            </thead>
            <tbody>
                @{ var serialNo = (_currentPage - 1) * _pageSize; }
                @foreach (var row in PagedData)
                {
                    serialNo++;
                    <tr>
                        <td>@serialNo</td>
                        <td>@row.BuyerName</td>
                        <td>@row.MemoNo</td>
                        <td>@row.MemoDate.ToString("yyyy-MM-dd")</td>
                        <td>@row.StyleName</td>
                        <td class="text-end">@row.GmtQty.ToString("N0")</td>
                        <td class="text-end">@row.GmtFobValue.ToString("N2")</td>
                        <td class="text-end">@row.SurchargePaid.ToString("N2")</td>
                        <td class="text-end">@row.StockUsableAmount.ToString("N2")</td>
                        <td class="text-end">@row.StockNonUsableAmount.ToString("N2")</td>
                        <td class="text-end">@row.TotalExtraPaid.ToString("N2")</td>
                        <td class="text-end">@row.AmountCosting.ToString("N2")</td>
                        <td class="text-end">@row.AmountDN.ToString("N2")</td>
                        <td class="text-end">@row.Saving.ToString("N2")</td>
                        <td class="text-end">@row.AmountCommitment.ToString("N2")</td>
                        <td class="text-end">@string.Format("{0:P2}",@row.PercentOfFobValue)</td>
                        <td>@row.UserName</td>
                        <td><span class="badge bg-@GetStatusBadgeColor(row.ApprovalStatus)">@(row.ApprovalStatus ?? "Pending")</span></td>
                    </tr>
                }
            </tbody>
            <tfoot class="table-secondary fw-bold">
                <tr>
                    <td colspan="5">Total</td>
                    <td class="text-end">@_data.Sum(x => x.GmtQty).ToString("N0")</td>
                    <td class="text-end">@_data.Sum(x => x.GmtFobValue).ToString("N2")</td>
                    <td class="text-end">@_data.Sum(x => x.SurchargePaid).ToString("N2")</td>
                    <td class="text-end">@_data.Sum(x => x.StockUsableAmount).ToString("N2")</td>
                    <td class="text-end">@_data.Sum(x => x.StockNonUsableAmount).ToString("N2")</td>
                    <td class="text-end">@_data.Sum(x => x.TotalExtraPaid).ToString("N2")</td>
                    <td class="text-end">@_data.Sum(x => x.AmountCosting).ToString("N2")</td>
                    <td class="text-end">@_data.Sum(x => x.AmountDN).ToString("N2")</td>
                    <td class="text-end">@_data.Sum(x => x.Saving).ToString("N2")</td>
                    <td class="text-end">@_data.Sum(x => x.AmountCommitment).ToString("N2")</td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <div class="d-flex justify-content-between align-items-center">
        <div>Showing @((_currentPage - 1) * _pageSize + 1) - @(Math.Min(_currentPage * _pageSize, FilteredData.Count())) of @FilteredData.Count()</div>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item @(_currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="#" @onclick="PrevPage" @onclick:preventDefault>Prev</a>
                </li>
                @for (var p = 1; p <= TotalPages; p++)
                {
                    var page = p;
                    <li class="page-item @(p == _currentPage ? "active" : "")">
                        <a class="page-link" href="#" @onclick="() => GotoPage(page)" @onclick:preventDefault>@p</a>
                    </li>
                }
                <li class="page-item @(_currentPage == TotalPages ? "disabled" : "")">
                    <a class="page-link" href="#" @onclick="NextPage" @onclick:preventDefault>Next</a>
                </li>
            </ul>
        </nav>
    </div>
}

@code {

    private List<ReportRow> _data = new();
    private bool _loading = true;
    private string _searchText = string.Empty;
    private DateTime? _dateFrom;
    private DateTime? _dateTo;
    private string _approvalStatusFilter = string.Empty;
    private int _pageSize = 25;
    private int _currentPage = 1;
    private bool _isAcct = false;

    private IEnumerable<ReportRow> FilteredData 
    {
        get
        {
            var filtered = _data.AsEnumerable();
            
            if (!string.IsNullOrWhiteSpace(_searchText))
            {
                filtered = filtered.Where(r => 
                    (r.BuyerName ?? "").Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                    (r.MemoNo ?? "").Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                    (r.StyleName ?? "").Contains(_searchText, StringComparison.OrdinalIgnoreCase));
            }
            
            if (!string.IsNullOrWhiteSpace(_approvalStatusFilter))
            {
                filtered = filtered.Where(r => 
                    (r.ApprovalStatus ?? "Pending").Equals(_approvalStatusFilter, StringComparison.OrdinalIgnoreCase));
            }
            
            return filtered;
        }
    }

    private List<ReportRow> PagedData => FilteredData.Skip((_currentPage - 1) * _pageSize).Take(_pageSize).ToList();
    private int TotalPages => Math.Max(1, (int)Math.Ceiling(FilteredData.Count() / (double)_pageSize));

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _isAcct = authState.User.IsInRole("Acct");
        if (_isAcct)
        {
            Nav.NavigateTo("/reports/detail", forceLoad: false);
            return;
        }
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _currentPage = 1;

        // Get current user ID for buyer privilege filtering
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        
        var allBuyers = await Db.MemoAddresses.Where(a => a.Type.Contains("B")).ToListAsync();
        var buyers = !string.IsNullOrEmpty(userId) 
            ? await BuyerPrivilegeService.FilterBuyersAsync(userId, allBuyers) 
            : allBuyers;
        
        var allowedBuyerIds = buyers.Select(b => b.Id).ToHashSet();

        var query = Db.Memos
            .Include(m => m.Details)
            .Include(m => m.MultiStyles)
                .ThenInclude(ms => ms.Style)
            .Where(m => m.BuyerId == null || allowedBuyerIds.Contains(m.BuyerId.Value))
            .AsQueryable();

        if (_isAcct)
        {
            query = query.Where(m => (m.ApproveStatus ?? string.Empty) == "Approved");
        }

        if (_dateFrom.HasValue)
            query = query.Where(m => m.MemoDate >= _dateFrom.Value);

        if (_dateTo.HasValue)
            query = query.Where(m => m.MemoDate <= _dateTo.Value);

        var memos = await query.ToListAsync();
        var styles = await Db.BuyerStyles.ToListAsync();
        var users = await Db.Users.ToDictionaryAsync(u => u.Id, u => u.UserName ?? u.Email ?? "");

        // create flat detail items first, then group by the requested keys and aggregate the sums
        var detailRows = memos.SelectMany(m => m.Details.Select(d => new
        {
            MemoNo = m.MemoNo,
            MemoDate = m.MemoDate,
            BuyerId = m.BuyerId,
            BuyerName = buyers.FirstOrDefault(b => b.Id == m.BuyerId)?.Name ?? "",
            // Use MultiStyles if available, otherwise fallback to legacy StyleId
            StyleName = m.HasMultiStyles 
                ? m.MultiStyleDisplay 
                : (styles.FirstOrDefault(s => s.Id == m.StyleId)?.StyleName ?? ""),
            // Use effective properties for backward compatibility
            GmtQty = m.EffectiveGmtQty,
            GmtFobRate = m.EffectiveFobRate,
            UserName = !string.IsNullOrEmpty(m.CreatedByUserId) && users.ContainsKey(m.CreatedByUserId) ? users[m.CreatedByUserId] : "",
            ApprovalStatus = m.ApproveStatus,
            SurchargePaid = d.SurchargePaid,
            StockUsableAmount = d.StockUsableQty * d.Price,
            StockNonUsableAmount = ( d.MCQQty - (d.BOMQty - d.AvailStockQty) - d.StockUsableQty) * d.Price,
            TotalExtraPaid = (d.Price * d.MCQQty) - (d.Price * (d.BOMQty - d.AvailStockQty)) + d.SurchargePaid,
            AmountCosting = d.ModeOfCollect == "C" ? d.TotalExtraCollected : 0m,
            AmountDN = d.ModeOfCollect == "D" ? d.TotalExtraCollected : 0m,
            Saving = (d.ModeOfCollect == "C" ? d.TotalExtraCollected : 0m) + (d.ModeOfCollect == "D" ? d.TotalExtraCollected : 0m) - ((d.Price * d.MCQQty) - (d.Price * (d.BOMQty - d.AvailStockQty)) + d.SurchargePaid),
            AmountCommitment = d.ModeOfCollect == "F" ? d.TotalExtraCollected : 0m
        }));

        //var gmtFobValue = m.GmtFobValue;

        _data = detailRows
             .GroupBy(x => new { x.MemoNo, x.MemoDate, x.BuyerId, x.BuyerName, x.StyleName, x.GmtQty, x.GmtFobRate, x.UserName, x.ApprovalStatus })
             .Select(g => new ReportRow
             {
                 MemoNo = g.Key.MemoNo,
                 MemoDate = g.Key.MemoDate,
                 BuyerId = g.Key.BuyerId,
                 BuyerName = g.Key.BuyerName,
                 StyleName = g.Key.StyleName,
                 GmtQty = g.Key.GmtQty,
                 GmtFobValue = g.Key.GmtQty * g.Key.GmtFobRate,
                 UserName = g.Key.UserName,
                 ApprovalStatus = g.Key.ApprovalStatus,
                 SurchargePaid = g.Sum(i => i.SurchargePaid),
                 StockUsableAmount = g.Sum(i => i.StockUsableAmount),
                 StockNonUsableAmount = g.Sum(i => i.StockNonUsableAmount),
                 TotalExtraPaid = g.Sum(i => i.TotalExtraPaid),
                 AmountCosting = g.Sum(i => i.AmountCosting),
                 AmountDN = g.Sum(i => i.AmountDN),
                 Saving = g.Sum(i => i.Saving),
                 AmountCommitment = g.Sum(i => i.AmountCommitment),
                 PercentOfFobValue = (g.Key.GmtFobRate != 0m && g.Key.GmtQty != 0)
                     ? g.Sum(i => i.TotalExtraPaid) / (g.Key.GmtQty * g.Key.GmtFobRate)
                     : 0m
             })
             .ToList();
        
        _loading = false;
    }

    private void ClearFilter()
    {
        _searchText = string.Empty;
        _dateFrom = null;
        _dateTo = null;
        _approvalStatusFilter = string.Empty;
        _currentPage = 1;
    }
    
    private string GetStatusBadgeColor(string? status)
    {
        return status switch
        {
            "Approved" => "success",
            "Rejected" => "danger",
            "Pending" => "warning",
            _ => "secondary"
        };
    }

    private void OnPageSizeChanged()
    {
        _currentPage = 1;
    }

    private void PrevPage()
    {
        if (_currentPage > 1) _currentPage--;
    }

    private void NextPage()
    {
        if (_currentPage < TotalPages) _currentPage++;
    }

    private void GotoPage(int p)
    {
        _currentPage = Math.Clamp(p, 1, TotalPages);
    }

    private async Task ExportExcel()
    {
        var csv = GenerateCsv();
        var bytes = System.Text.Encoding.UTF8.GetBytes(csv);
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", $"ReportSummary_{DateTime.Now:yyyyMMdd}.csv", "text/csv", base64);
    }

    private async Task ExportPdf()
    {
        await JS.InvokeVoidAsync("window.print");
    }

    private string GenerateCsv()
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("Serial No,Buyer,Memo #,Memo Date,Style,Gmt Qty,Gmt FOB Value,Surcharge Paid,Stock Usable Amount,Stock Non-Usable Amount,Total Extra Paid,Amount Costing,Amount DN,Amount Commitment,Percent Of Fob Value,User Name,Approval Status");
        
        var serial = 0;
        foreach (var row in FilteredData)
        {
            serial++;
            sb.AppendLine($"{serial},\"{row.BuyerName}\",\"{row.MemoNo}\",{row.MemoDate:yyyy-MM-dd},\"{row.StyleName}\",{row.GmtQty},{row.GmtFobValue},{row.SurchargePaid},{row.StockUsableAmount},{row.StockNonUsableAmount},{row.TotalExtraPaid},{row.AmountCosting},{row.AmountDN},{row.AmountCommitment},{row.PercentOfFobValue:P2},\"{row.UserName}\",\"{row.ApprovalStatus ?? "Pending"}\"");
        }
        
        return sb.ToString();
    }

    private class ReportRow
    {
        public int MemoId { get; set; }
        public string MemoNo { get; set; } = string.Empty;
        public DateTime MemoDate { get; set; }
        public int? BuyerId { get; set; }
        public string BuyerName { get; set; } = string.Empty;
        public string StyleName { get; set; } = string.Empty;
        public int GmtQty { get; set; }
        public decimal GmtFobValue { get; set; }
        public decimal SurchargePaid { get; set; }
        public int StockUsableQty { get; set; }
        public int StockNonUsableQty { get; set; }
        public decimal StockUsableAmount { get; set; }
        public decimal StockNonUsableAmount { get; set; }

        public decimal TotalExtraPaid { get; set; }
        public decimal AmountCosting { get; set; }
        public decimal AmountDN { get; set; }
        public decimal Saving { get; set; }
        public decimal AmountCommitment { get; set; }
        public decimal? PercentOfFobValue { get; set; }
        public string UserName { get; set; } = string.Empty;
        public string? ApprovalStatus { get; set; }
    }
}
