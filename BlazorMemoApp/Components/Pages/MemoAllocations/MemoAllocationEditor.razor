@page "/memo-allocations/new"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin,User")]
@rendermode InteractiveServer
@using BlazorMemoApp.Models
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject BlazorMemoApp.Data.ApplicationDbContext Db
@inject BlazorMemoApp.Services.PoApiClient PoApi
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject BlazorMemoApp.Services.BuyerPrivilegeService BuyerPrivilegeService

<h1>Create Memo Allocation</h1>
<hr />

<EditForm Model="header">
    <div class="row g-3">
        <div class="col-sm-2">
            <label class="form-label">Memo #</label>
            <input class="form-control" value="@header.MemoNo" disabled />
        </div>
        <div class="col-sm-2">
            <label class="form-label">Date</label>
            <input class="form-control" value="@header.MemoDate.ToString("yyyy-MM-dd HH:mm")" disabled />
        </div>
        <div class="col-sm-2">
            <label class="form-label">Unit Name</label>
            <InputSelect class="form-select" @bind-Value="header.UnitName">
                <option value="">-- Select Unit --</option>
                @foreach (var unit in UnitMaster.Units)
                {
                    <option value="@unit">@unit</option>
                }
            </InputSelect>
        </div>
        <div class="col-sm-3 position-relative">
            <label class="form-label">PO Number</label>
            <div class="input-group">
                <input class="form-control" @bind-value="SearchText" placeholder="Type part of PO No..." />
                <button type="button" class="btn btn-outline-primary" title="Search PO" @onclick="SearchPosAsync">Search</button>
            </div>
            @if (suggestions.Count > 0 && showSuggestions)
            {
                <div class="list-group position-absolute z-3" style="max-height:200px; overflow:auto; width:100%;">
                    @foreach (var s in suggestions)
                    {
                        <button type="button" class="list-group-item list-group-item-action" @onclick="() => SelectPo(s)">@s</button>
                    }
                </div>
            }
        </div>
        <div class="col-sm-2">
            <label class="form-label">PO Selected</label>
            <input class="form-control" value="@header.PONo" disabled />
        </div>
    </div>
</EditForm>

<hr />

<BlazorMemoApp.Components.MemoAllocations.MemoAllocationDetailGrid 
    Items="header.Details" 
    UnitName="@header.UnitName"
    PONo="@header.PONo"
    Buyers="buyers"
    Orders="orders" />

<div class="mt-3 d-flex gap-2">
    <button class="btn btn-secondary" @onclick="Cancel">Cancel</button>
    <button class="btn btn-primary" @onclick="Save">Save</button>
</div>

@if (!string.IsNullOrEmpty(_saveMessage))
{
    <div class="alert @(_saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show mt-2">
        @_saveMessage
        <button type="button" class="btn-close" @onclick="() => _saveMessage = string.Empty"></button>
    </div>
}

@code {
    private MemoAllocationHeaderModel header = new();
    private string searchText = string.Empty;
    private bool showSuggestions = false;
    private List<string> suggestions = new();

    private List<MemoAdressModel> buyers = new();
    private List<BuyerStyleOrderModel> orders = new();

    private string _saveMessage = string.Empty;
    private bool _saveSuccess = false;

    private string SearchText
    {
        get => searchText;
        set => searchText = value ?? string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        var allBuyers = await Db.MemoAddresses.Where(a => a.Type.Contains("B")).ToListAsync();
        buyers = !string.IsNullOrEmpty(userId)
            ? await BuyerPrivilegeService.FilterBuyersAsync(userId, allBuyers)
            : allBuyers;

        orders = await Db.BuyerStyleOrders.ToListAsync();
        header.MemoNo = await GenerateMemoNoAsync();
        header.MemoDate = DateTime.Now;
    }

    private async Task<string> GenerateMemoNoAsync()
    {
        var currentYear = DateTime.Now.Year;
        var yearPrefix = $"MG{currentYear.ToString().Substring(2)}";
        var countThisYear = await Db.MemoAllocations
            .Where(m => m.MemoNo != null && m.MemoNo.StartsWith(yearPrefix))
            .CountAsync();
        int nextSerial = countThisYear + 1;
        var dateStr = DateTime.Now.ToString("yyMMdd");
        return $"MG{dateStr}{nextSerial:D6}";
    }

    private async Task SearchPosAsync()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            suggestions.Clear();
            showSuggestions = false;
            return;
        }
        suggestions = await PoApi.SearchPosAsync(searchText);
        showSuggestions = suggestions.Count > 0;
        StateHasChanged();
    }

    private async Task SelectPo(string po)
    {
        header.PONo = po;
        showSuggestions = false;
        suggestions.Clear();
        searchText = po;

        var poItems = await PoApi.GetPoDetailsAsync(po);
        var newDetails = poItems.Select(d => new MemoAllocationDetailModel
        {
            Article = d.Article,
            Color = d.Color,
            Size = d.Spec_Value,
            ItemCode = d.Custom1,
            Supplier = d.Supplier,
            UnitPO = d.Uom_Po,
            RatePO = d.Rate,
            CurrencyPO = d.Currency
        }).ToList();

        header.Details ??= new List<MemoAllocationDetailModel>();
        header.Details.AddRange(newDetails);

        StateHasChanged();
    }

    private void Cancel() => Nav.NavigateTo("/memo-allocations");

    private async Task Save()
    {
        _saveMessage = string.Empty;
        _saveSuccess = false;

        if (string.IsNullOrWhiteSpace(header.UnitName))
        {
            _saveMessage = "Please select Unit Name.";
            return;
        }

        if (string.IsNullOrWhiteSpace(header.PONo))
        {
            _saveMessage = "Please select a PO.";
            return;
        }

        if (header.Details == null || !header.Details.Any())
        {
            _saveMessage = "Please add at least one detail item.";
            return;
        }

        try
        {
            header.MemoNo = await GenerateMemoNoAsync();
            Db.MemoAllocations.Add(header);
            await Db.SaveChangesAsync();

            _saveMessage = $"Memo Allocation {header.MemoNo} saved successfully.";
            _saveSuccess = true;
            StateHasChanged();

            await Task.Delay(1500);
            Nav.NavigateTo("/memo-allocations");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error saving memo allocation: {ex.Message}");
            _saveMessage = $"Error saving: {ex.Message}";
            _saveSuccess = false;
        }
    }
}
