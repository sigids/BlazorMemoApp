@page "/memo-allocations"
@* @attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin,User")] *@
@rendermode InteractiveServer
@using BlazorMemoApp.Models
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using System.Text
@using System.Globalization
@inject BlazorMemoApp.Data.ApplicationDbContext Db
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject BlazorMemoApp.Services.BuyerPrivilegeService BuyerPrivilegeService
@inject BlazorMemoApp.Services.FactoryPrivilegeService FactoryPrivilegeService

<h1>Memo Allocation List</h1>

<div class="mb-3 d-flex gap-2 flex-wrap align-items-center">
    @if (!_isPpic)
    {
        <button class="btn btn-primary" @onclick="CreateNew">Create Memo Allocation</button>
    }

    <div class="input-group" style="max-width:340px;">
        <span class="input-group-text">Search</span>
        <input class="form-control form-control-sm" @bind="_filter" placeholder="Memo No, PO No, Unit, Buyer" />
    </div>

    <div>
        <select class="form-select form-select-sm" style="width:90px;" @bind="_pageSize">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
        </select>
    </div>
</div>

@if (_allItems is null)
{
    <p><em>Loading...</em></p>
}
else if (!_allItems.Any())
{
    <p>No memo allocations found.</p>
}
else
{
    <div style="overflow-x:auto;">
        <table class="table table-sm table-bordered align-middle" style="min-width: max-content;">
            <thead class="table-light">
                <tr>
                    <th>Memo #</th>
                    <th>Date</th>
                    <th>Unit</th>
                    <th>PO No</th>
                    <th>Buyer</th>
                    <th class="text-center">Details Count</th>
                    <th class="text-end">Total Qty Pass</th>
                    <th class="text-end">Total Amount Pass</th>
                    <th class="text-end">Total Qty Allocate</th>
                    <th class="text-end">Total Qty Balance</th>
                    <th class="text-center">WH Approval</th>
                    <th class="text-center">QC Approval</th>
                    <th style="width:200px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in PagedItems)
                {
                    <tr>
                        <td>@item.MemoNo</td>
                        <td>@item.MemoDate.ToString("yyyy-MM-dd")</td>
                        <td>@item.UnitName</td>
                        <td>@item.PONo</td>
                        <td>@(item.Buyer != null ? $"{item.Buyer.Name} - {item.Buyer.NameAbbr}" : "")</td>
                        <td class="text-center">@item.Details.Count</td>
                        <td class="text-end">@item.Details.Sum(d => d.QtyPass).ToString("N2")</td>
                        <td class="text-end">@item.Details.Sum(d => d.AmountPass).ToString("N2")</td>
                        <td class="text-end">@item.Details.Sum(d => d.QtyAllocate).ToString("N2")</td>
                        <td class="text-end">@item.Details.Sum(d => d.QtyBalance).ToString("N2")</td>
                        <td class="text-center">
                            @if (item.WhApprovalStatus)
                            {
                                <span class="badge bg-success" title="@item.WhApprovalUserName - @item.WhApprovalDate?.ToString("yyyy-MM-dd HH:mm")">Approved</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Pending</span>
                            }
                        </td>
                        <td class="text-center">
                            @if (item.QcApprovalStatus)
                            {
                                <span class="badge bg-info" title="@item.QcApprovalUserName - @item.QcApprovalDate?.ToString("yyyy-MM-dd HH:mm")">Approved</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Pending</span>
                            }
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                @if (!_isPpic)
                                {
                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => EditItem(item.Id)">Edit</button>
                                }
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ViewItem(item.Id)">View</button>
                                <button class="btn btn-sm btn-outline-success" @onclick="() => ExportCsv(item.Id)">CSV</button>
                                @if (!_isPpic && (_isAdmin || _isSupervisor))
                                {
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteItem(item.Id)">Delete</button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center">
        <div>Showing @(FilteredItems.Any() ? (_currentPage-1)*_pageSize+1 : 0)-@(((_currentPage-1)*_pageSize)+PagedItems.Count()) of @FilteredItems.Count()</div>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item @(_currentPage==1?"disabled":"")">
                    <button type="button" class="page-link" @onclick="PrevPage" disabled="@(_currentPage==1)">Prev</button>
                </li>
                @for (var p = 1; p <= TotalPages; p++)
                {
                    var page = p;
                    <li class="page-item @(p==_currentPage?"active":"")">
                        <button type="button" class="page-link" @onclick="(()=>GotoPage(page))">@p</button>
                    </li>
                }
                <li class="page-item @(_currentPage==TotalPages?"disabled":"")">
                    <button type="button" class="page-link" @onclick="NextPage" disabled="@(_currentPage==TotalPages)">Next</button>
                </li>
            </ul>
        </nav>
    </div>
}

@code {
    private List<MemoAllocationHeaderModel>? _allItems;
    private string _filter = string.Empty;
    private int _pageSize = 10;
    private int _currentPage = 1;
    private bool _isAdmin = false;
    private bool _isSupervisor = false;
    private bool _hasFactoryRole = false;
    private bool _isPpic = false;
    private HashSet<int> _allowedBuyerIds = new();
    private HashSet<string> _allowedUnits = new();

    private IEnumerable<MemoAllocationHeaderModel> FilteredItems
        => (_allItems ?? Enumerable.Empty<MemoAllocationHeaderModel>())
            .Where(m => string.IsNullOrWhiteSpace(_filter)
                        || (m.MemoNo ?? string.Empty).Contains(_filter, StringComparison.OrdinalIgnoreCase)
                        || (m.PONo ?? string.Empty).Contains(_filter, StringComparison.OrdinalIgnoreCase)
                        || (m.UnitName ?? string.Empty).Contains(_filter, StringComparison.OrdinalIgnoreCase)
                        || (m.Buyer?.Name ?? string.Empty).Contains(_filter, StringComparison.OrdinalIgnoreCase)
                        || (m.Buyer?.NameAbbr ?? string.Empty).Contains(_filter, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<MemoAllocationHeaderModel> PagedItems => FilteredItems.Skip((_currentPage - 1) * _pageSize).Take(_pageSize);
    private int TotalPages => Math.Max(1, (int)Math.Ceiling(FilteredItems.Count() / (double)_pageSize));

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        _isAdmin = authState.User.IsInRole("Admin");
        _isSupervisor = authState.User.IsInRole("Supervisor");

        // Check factory role and get allowed units
        if (!string.IsNullOrEmpty(userId))
        {
            _hasFactoryRole = await FactoryPrivilegeService.HasFactoryRoleAsync(userId);
            _isPpic = await FactoryPrivilegeService.IsPpicUserAsync(userId);
            if (_hasFactoryRole)
            {
                var hasAllUnits = await FactoryPrivilegeService.HasAllUnitsAccessAsync(userId);
                if (!hasAllUnits)
                {
                    var allowedUnits = await FactoryPrivilegeService.GetAllowedUnitsAsync(userId);
                    _allowedUnits = allowedUnits.ToHashSet(StringComparer.OrdinalIgnoreCase);
                }
            }
        }

        // Get allowed buyers for this user (only for non-factory roles)
        var allBuyers = await Db.MemoAddresses.Where(a => a.Type.Contains("B")).ToListAsync();
        var allowedBuyers = !string.IsNullOrEmpty(userId)
            ? await BuyerPrivilegeService.FilterBuyersAsync(userId, allBuyers)
            : allBuyers;
        _allowedBuyerIds = allowedBuyers.Select(b => b.Id).ToHashSet();

        var query = Db.MemoAllocations
            .Include(m => m.Buyer)
            .Include(m => m.Details).ThenInclude(d => d.SpiAllocations)
            .AsQueryable();

        // Filter based on role type
        if (!_isAdmin)
        {
            if (_hasFactoryRole)
            {
                // Factory roles: filter by unit access only
                var hasAllUnits = await FactoryPrivilegeService.HasAllUnitsAccessAsync(userId!);
                if (!hasAllUnits && _allowedUnits.Any())
                {
                    query = query.Where(m => _allowedUnits.Contains(m.UnitName ?? ""));
                }
            }
            else
            {
                // Non-factory roles: filter by buyer access
                query = query.Where(m => m.BuyerId == null || _allowedBuyerIds.Contains(m.BuyerId.Value));
            }
        }

        _allItems = await query.OrderByDescending(m => m.MemoDate).ToListAsync();

        if (_currentPage > TotalPages) _currentPage = TotalPages;
    }

    private void CreateNew() => Nav.NavigateTo("/memo-allocations/new");
    private void EditItem(int id) => Nav.NavigateTo($"/memo-allocations/{id}");
    private void ViewItem(int id) => Nav.NavigateTo($"/memo-allocations/{id}/view");

    private async Task DeleteItem(int id)
    {
        if (!_isAdmin) return;

        var item = _allItems?.FirstOrDefault(m => m.Id == id);
        if (item == null) return;

        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Delete memo allocation {item.MemoNo}?");
        if (!confirmed) return;

        try
        {
            Db.MemoAllocations.Remove(item);
            await Db.SaveChangesAsync();
            _allItems?.Remove(item);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error deleting memo allocation: {ex.Message}");
        }
    }

    private async Task ExportCsv(int id)
    {
        var header = await Db.MemoAllocations
            .Include(m => m.Buyer)
            .Include(m => m.Details).ThenInclude(d => d.Buyer)
            .FirstOrDefaultAsync(m => m.Id == id);

        if (header == null) return;

        var sb = new StringBuilder();
        // Header info (key,value)
        sb.AppendLine("Field,Value");
        sb.AppendLine($"MemoNo,{EscapeCsv(header.MemoNo)}");
        sb.AppendLine($"MemoDate,{header.MemoDate.ToString("yyyy-MM-dd HH:mm", CultureInfo.InvariantCulture)}");
        sb.AppendLine($"UnitName,{EscapeCsv(header.UnitName)}");
        sb.AppendLine($"PONo,{EscapeCsv(header.PONo)}");
        sb.AppendLine($"Buyer,{EscapeCsv(header.Buyer?.Name ?? "")}");
        sb.AppendLine($"WhApprovalStatus,{header.WhApprovalStatus}");
        sb.AppendLine($"WhApprovalUserName,{EscapeCsv(header.WhApprovalUserName)}");
        sb.AppendLine($"WhApprovalDate,{(header.WhApprovalDate?.ToString("yyyy-MM-dd HH:mm", CultureInfo.InvariantCulture) ?? string.Empty)}");
        sb.AppendLine($"QcApprovalStatus,{header.QcApprovalStatus}");
        sb.AppendLine($"QcApprovalUserName,{EscapeCsv(header.QcApprovalUserName)}");
        sb.AppendLine($"QcApprovalDate,{(header.QcApprovalDate?.ToString("yyyy-MM-dd HH:mm", CultureInfo.InvariantCulture) ?? string.Empty)}");
        sb.AppendLine();

        // Details header
        sb.AppendLine("PONo,MatName,Article,Color,Size,ItemCode,Supplier,UnitPO,RatePO,CurrencyPO,QtyStage,QtyActual,DateConfWh,QtyPass,DateConfQc,AmountPass,Buyer,QtyAllocate,AmountAllocate,QtyBalance,AmountBalance,Remark");

        foreach (var d in header.Details ?? Enumerable.Empty<MemoAllocationDetailModel>())
        {
            var line = string.Join(",",
                EscapeCsv(d.PONo),
                EscapeCsv(d.MatName),
                EscapeCsv(d.Article),
                EscapeCsv(d.Color),
                EscapeCsv(d.Size),
                EscapeCsv(d.ItemCode),
                EscapeCsv(d.Supplier),
                EscapeCsv(d.UnitPO),
                d.RatePO.ToString("F4", CultureInfo.InvariantCulture),
                EscapeCsv(d.CurrencyPO),
                d.QtyStage.ToString("F2", CultureInfo.InvariantCulture),
                d.QtyActual.ToString("F2", CultureInfo.InvariantCulture),
                EscapeCsv(d.DateConfWh?.ToString("MM/dd HH:mm") ?? ""),
                d.QtyPass.ToString("F2", CultureInfo.InvariantCulture),
                EscapeCsv(d.DateConfQc?.ToString("MM/dd HH:mm") ?? ""),
                d.AmountPass.ToString("F2", CultureInfo.InvariantCulture),
                EscapeCsv(d.Buyer?.Name ?? ""),
                d.QtyAllocate.ToString("F2", CultureInfo.InvariantCulture),
                d.AmountAllocate.ToString("F2", CultureInfo.InvariantCulture),
                d.QtyBalance.ToString("F2", CultureInfo.InvariantCulture),
                d.AmountBalance.ToString("F2", CultureInfo.InvariantCulture),
                EscapeCsv(d.Remark)
            );
            sb.AppendLine(line);
        }

        var csv = sb.ToString();
        var bytes = Encoding.UTF8.GetBytes(csv);
        var base64 = Convert.ToBase64String(bytes);
        var filename = $"{(string.IsNullOrWhiteSpace(header.MemoNo) ? "memoallocation" : header.MemoNo)}_{header.Id}.csv".Replace("\"", "");

        var safeBase64 = base64.Replace("'", "\\'");
        var safeFilename = filename.Replace("'", "\\'");
        var js = $"(function(b64, filename){{var link=document.createElement('a');link.href='data:text/csv;base64,'+b64;link.download=filename;document.body.appendChild(link);link.click();document.body.removeChild(link);}})('{safeBase64}','{safeFilename}');";
        await JS.InvokeVoidAsync("eval", js);
    }

    private static string EscapeCsv(string? input)
    {
        if (string.IsNullOrEmpty(input)) return string.Empty;
        var needQuotes = input.Contains(',') || input.Contains('"') || input.Contains('\r') || input.Contains('\n');
        var outVal = input.Replace("\"", "\"\"");
        return needQuotes ? '"' + outVal + '"' : outVal;
    }

    private void PrevPage() { if (_currentPage > 1) _currentPage--; }
    private void NextPage() { if (_currentPage < TotalPages) _currentPage++; }
    private void GotoPage(int p) { _currentPage = Math.Min(Math.Max(1, p), TotalPages); }
}
