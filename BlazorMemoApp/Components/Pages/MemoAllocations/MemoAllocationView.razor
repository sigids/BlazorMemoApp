@page "/memo-allocations/{Id:int}"
@page "/memo-allocations/{Id:int}/view"
@* No role restriction - access control is done in code based on factory role and buyer/unit privileges *@
@rendermode InteractiveServer
@using BlazorMemoApp.Models
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@inject BlazorMemoApp.Data.ApplicationDbContext Db
@inject BlazorMemoApp.Services.PoApiClient PoApi
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject BlazorMemoApp.Services.BuyerPrivilegeService BuyerPrivilegeService
@inject BlazorMemoApp.Services.FactoryPrivilegeService FactoryPrivilegeService
@inject IHttpClientFactory HttpClientFactory

<h1>Memo Allocation @header?.MemoNo</h1>
<hr />

@if (_accessDenied)
{
    <div class="alert alert-danger">
        <strong>Access Denied:</strong> You do not have permission to view this memo allocation.
    </div>
    <button class="btn btn-secondary" @onclick="Back">Back</button>
}
else if (header is null)
{
    <p><em>Loading...</em></p>
}
else
{
    @if (_isViewMode)
    {
        <div class="alert alert-info py-2 mb-3">
            <strong>View Mode:</strong> This memo allocation is in read-only mode.
        </div>
    }

    <EditForm Model="header">
        <div class="row g-3">
            <div class="col-sm-2">
                <label class="form-label">Memo #</label>
                <input class="form-control" value="@header.MemoNo" disabled />
            </div>
            <div class="col-sm-2">
                <label class="form-label">Date</label>
                <input class="form-control" value="@header.MemoDate.ToString("yyyy-MM-dd HH:mm")" disabled />
            </div>
            <div class="col-sm-2">
                <label class="form-label">Unit Name</label>
                <InputSelect class="form-select" @bind-Value="header.UnitName" disabled="@_isViewMode">
                    <option value="">-- Select Unit --</option>
                    @foreach (var unit in UnitMaster.Units)
                    {
                        <option value="@unit">@unit</option>
                    }
                </InputSelect>
            </div>
            <div class="col-sm-2">
                <label class="form-label">PO No</label>
                <input class="form-control" value="@header.PONo" disabled />
            </div>
            <div class="col-sm-2">
                <label class="form-label">Buyer</label>
                @if (_isViewMode)
                {
                    <input class="form-control" value="@(header.Buyer != null ? $"{header.Buyer.Name} - {header.Buyer.NameAbbr}" : "")" disabled />
                }
                else
                {
                    <InputSelect class="form-select" @bind-Value="header.BuyerId">
                        <option value="">-- Select Buyer --</option>
                        @foreach (var b in buyers)
                        {
                            <option value="@b.Id">@b.Name - @b.NameAbbr</option>
                        }
                    </InputSelect>
                }
            </div>
        </div>

        <div class="row g-3 mt-2">
            @if (!_isViewMode)
            {
                <div class="col-sm-3 position-relative">
                    <label class="form-label">Add More PO Items</label>
                    <div class="input-group">
                        <input class="form-control" @bind-value="SearchText" placeholder="Type part of PO No..." />
                        <button type="button" class="btn btn-outline-primary" title="Search PO" @onclick="SearchPosAsync">Search</button>
                    </div>
                    @if (suggestions.Count > 0 && showSuggestions)
                    {
                        <div class="list-group position-absolute z-3" style="max-height:200px; overflow:auto; width:100%;">
                            @foreach (var s in suggestions)
                            {
                                <button type="button" class="list-group-item list-group-item-action" @onclick="() => SelectPo(s)">@s</button>
                            }
                        </div>
                    }
                </div>
            }
        </div>
        
        @if (!_isViewMode)
        {
            <div class="row g-3 mt-2">
                <div class="col-sm-4 d-flex align-items-end flex-column">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-info" @onclick="CalculateUsd" disabled="@_calculating">
                            @(_calculating ? "Calculating..." : "Calculate USD")
                        </button>
                    </div>
                    @if (!string.IsNullOrEmpty(_calcMessage))
                    {
                        <div class="alert @(_calcSuccess ? "alert-success" : "alert-danger") alert-dismissible py-1 px-2 mt-1 mb-0" style="font-size:0.85rem;">
                            @_calcMessage
                            <button type="button" class="btn-close btn-sm" @onclick="() => _calcMessage = string.Empty"></button>
                        </div>
                    }
                </div>
            </div>
        }
    </EditForm>

    <hr />

    @if (_isViewMode)
    {
        <h5>Details</h5>
        <div style="overflow-x: auto;">
            <table class="table table-bordered table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th></th>
                        <th>PO No</th>
                        <th>Mat Name</th>
                        <th>Article</th>
                        <th>Color</th>
                        <th>Size</th>
                        <th>Item Code</th>
                        <th>Supplier</th>
                        <th>Unit PO</th>
                        <th class="text-end">Rate PO</th>
                        <th>Currency</th>
                        <th class="text-end">Qty Stage</th>
                        <th class="text-end">Qty Actual</th>
                        <th>Date Conf Wh</th>
                        <th class="text-end">Qty Pass</th>
                        <th>Date Conf Qc</th>
                        <th class="text-end">Amount Pass</th>
                        <th>Buyer</th>
                        <th class="text-end">Qty Allocate</th>
                        <th class="text-end">Amount Allocate</th>
                        <th class="text-end">Qty Balance</th>
                        <th class="text-end">Amount Balance</th>
                        <th>Remark</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var detail in header.Details)
                    {
                        <tr>
                            <td>
                                <span style="cursor: pointer;" @onclick="() => ToggleDetailExpansion(detail)">
                                    @if (_expandedDetails.Contains(detail))
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                            <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z" />
                                        </svg>
                                    }
                                </span>
                            </td>
                            <td>@detail.PONo</td>
                            <td>@detail.MatName</td>
                            <td>@detail.Article</td>
                            <td>@detail.Color</td>
                            <td>@detail.Size</td>
                            <td>@detail.ItemCode</td>
                            <td>@detail.Supplier</td>
                            <td>@detail.UnitPO</td>
                            <td class="text-end">@detail.RatePO.ToString("N4")</td>
                            <td>@detail.CurrencyPO</td>
                            <td class="text-end">@detail.QtyStage.ToString("N2")</td>
                            <td class="text-end">@detail.QtyActual.ToString("N2")</td>
                            <td style="font-size:0.75rem;">@(detail.DateConfWh?.ToString("MM/dd HH:mm") ?? "")</td>
                            <td class="text-end">@detail.QtyPass.ToString("N2")</td>
                            <td style="font-size:0.75rem;">@(detail.DateConfQc?.ToString("MM/dd HH:mm") ?? "")</td>
                            <td class="text-end">@detail.AmountPass.ToString("N2")</td>
                            <td>@(detail.Buyer != null ? $"{detail.Buyer.Name}" : "")</td>
                            <td class="text-end">@detail.QtyAllocate.ToString("N2")</td>
                            <td class="text-end">@detail.AmountAllocate.ToString("N2")</td>
                            <td class="text-end">@detail.QtyBalance.ToString("N2")</td>
                            <td class="text-end">@detail.AmountBalance.ToString("N2")</td>
                            <td>@detail.Remark</td>
                        </tr>
                        @if (_expandedDetails.Contains(detail) && detail.SpiAllocations.Any())
                        {
                            <tr>
                                <td colspan="23" class="p-0">
                                    <div class="p-3 bg-light">
                                        <h6>SPI Allocations</h6>
                                        <table class="table table-sm table-bordered mb-0">
                                            <thead>
                                                <tr>
                                                    <th>SPI No</th>
                                                    <th class="text-end">Qty Allocate</th>
                                                    <th>Buyer Allocated</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var spi in detail.SpiAllocations)
                                                {
                                                    <tr>
                                                        <td>@spi.SpiNo</td>
                                                        <td class="text-end">@spi.QtyAllocate.ToString("N2")</td>
                                                        <td>@(spi.BuyerAllocated != null ? $"{spi.BuyerAllocated.Name} - {spi.BuyerAllocated.NameAbbr}" : "")</td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <BlazorMemoApp.Components.MemoAllocations.MemoAllocationDetailGrid
            Items="header.Details"
            UnitName="@header.UnitName"
            PONo="@header.PONo"
            Buyers="buyers"
            Orders="orders"
            IsWarehouse="_isWarehouse"
            IsQc="_isQc"
            IsPpic="_isPpic"
            WhApproved="header.WhApprovalStatus"
            QcApproved="header.QcApprovalStatus" />
    }

    <div class="mt-3 d-flex gap-2 flex-wrap">
        <button class="btn btn-secondary" @onclick="Back">Back</button>
        @if (!_isViewMode)
        {
            <button class="btn btn-primary" @onclick="Save">Save</button>
            @if (_isAdmin)
            {
                <button class="btn btn-danger" @onclick="Delete">Delete</button>
            }
        }
        <button class="btn btn-outline-primary" @onclick="Print">Print</button>
        
        @if (_isWarehouse && !header.WhApprovalStatus)
        {
            <button class="btn btn-success" @onclick="WhApproval">WH Approval</button>
        }
        @if (_isQc && !header.QcApprovalStatus)
        {
            <button class="btn btn-info" @onclick="QcApproval">QC Approval</button>
        }
    </div>
    
    @if (header.WhApprovalStatus || header.QcApprovalStatus)
    {
        <div class="mt-2">
            @if (header.WhApprovalStatus)
            {
                <span class="badge bg-success me-2">
                    WH Approved: @header.WhApprovalUserName (@header.WhApprovalDate?.ToString("yyyy-MM-dd HH:mm"))
                </span>
            }
            @if (header.QcApprovalStatus)
            {
                <span class="badge bg-info">
                    QC Approved: @header.QcApprovalUserName (@header.QcApprovalDate?.ToString("yyyy-MM-dd HH:mm"))
                </span>
            }
        </div>
    }

    @if (!string.IsNullOrEmpty(_saveMessage))
    {
        <div class="alert @(_saveSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show mt-2">
            @_saveMessage
            <button type="button" class="btn-close" @onclick="() => _saveMessage = string.Empty"></button>
        </div>
    }
}

@code {
    [Parameter] public int Id { get; set; }

    private MemoAllocationHeaderModel? header;
    private bool _isViewMode = false;
    private bool _isAdmin = false;
    private bool _accessDenied = false;

    // Factory role flags
    private bool _isWarehouse = false;
    private bool _isQc = false;
    private bool _isPpic = false;
    private bool _hasFactoryRole = false;
    private string _currentUserId = string.Empty;
    private string _currentUserName = string.Empty;

    private List<MemoAdressModel> buyers = new();
    private List<BuyerStyleOrderModel> orders = new();

    private string searchText = string.Empty;
    private bool showSuggestions = false;
    private List<string> suggestions = new();

    private string _saveMessage = string.Empty;
    private bool _saveSuccess = false;
    
    private bool _calculating = false;
    private string _calcMessage = string.Empty;
    private bool _calcSuccess = false;

    private HashSet<MemoAllocationDetailModel> _expandedDetails = new();

    private string SearchText
    {
        get => searchText;
        set => searchText = value ?? string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        _isViewMode = Nav.Uri.EndsWith("/view", StringComparison.OrdinalIgnoreCase);

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        _currentUserId = userId ?? string.Empty;
        _currentUserName = authState.User.Identity?.Name ?? string.Empty;
        _isAdmin = authState.User.IsInRole("Admin");

        // Check factory role
        if (!string.IsNullOrEmpty(userId))
        {
            _isWarehouse = await FactoryPrivilegeService.IsWarehouseUserAsync(userId);
            _isQc = await FactoryPrivilegeService.IsQcUserAsync(userId);
            _isPpic = await FactoryPrivilegeService.IsPpicUserAsync(userId);
            _hasFactoryRole = _isWarehouse || _isQc || _isPpic;
        }

        header = await Db.MemoAllocations
            .Include(m => m.Buyer)
            .Include(m => m.Details).ThenInclude(d => d.SpiAllocations).ThenInclude(s => s.BuyerAllocated)
            .Include(m => m.Details).ThenInclude(d => d.Buyer)
            .FirstOrDefaultAsync(m => m.Id == Id);

        var allBuyers = await Db.MemoAddresses.Where(a => a.Type.Contains("B")).ToListAsync();
        buyers = !string.IsNullOrEmpty(userId)
            ? await BuyerPrivilegeService.FilterBuyersAsync(userId, allBuyers)
            : allBuyers;

        // Check access based on role type
        if (header != null && !_isAdmin && !string.IsNullOrEmpty(userId))
        {
            if (_hasFactoryRole)
            {
                // Factory roles: check unit access only
                var hasUnitAccess = await FactoryPrivilegeService.HasUnitAccessAsync(userId, header.UnitName);
                if (!hasUnitAccess)
                {
                    _accessDenied = true;
                    header = null;
                }
            }
            else
            {
                // Non-factory roles: check buyer access
                if (header.BuyerId.HasValue)
                {
                    var allowedBuyerIds = buyers.Select(b => b.Id).ToHashSet();
                    if (!allowedBuyerIds.Contains(header.BuyerId.Value))
                    {
                        _accessDenied = true;
                        header = null;
                    }
                }
            }
        }

        orders = await Db.BuyerStyleOrders.ToListAsync();
    }

    private void ToggleDetailExpansion(MemoAllocationDetailModel detail)
    {
        if (_expandedDetails.Contains(detail))
            _expandedDetails.Remove(detail);
        else
            _expandedDetails.Add(detail);
    }

    private async Task SearchPosAsync()
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            suggestions.Clear();
            showSuggestions = false;
            return;
        }
        suggestions = await PoApi.SearchPosAsync(searchText);
        showSuggestions = suggestions.Count > 0;
        StateHasChanged();
    }

    private async Task SelectPo(string po)
    {
        if (header == null) return;

        header.PONo = po;
        showSuggestions = false;
        suggestions.Clear();
        searchText = po;

        var poItems = await PoApi.GetPoDetailsAsync(po);
        var newDetails = poItems.Select(d => new MemoAllocationDetailModel
        {
            PONo = po,
            MatName = d.Mat_Name,
            Article = d.Article,
            Color = d.Color,
            Size = d.Spec_Value,
            ItemCode = d.Custom1,
            Supplier = d.Supplier,
            UnitPO = d.Uom_Po,
            RatePO = d.Rate,
            CurrencyPO = d.Currency
        }).ToList();

        header.Details ??= new List<MemoAllocationDetailModel>();
        header.Details.AddRange(newDetails);

        StateHasChanged();
    }

    private async Task CalculateUsd()
    {
        if (header == null) return;
        
        _calculating = true;
        _calcMessage = string.Empty;
        _calcSuccess = false;
        StateHasChanged();

        try
        {
            if (header.MemoDate == default)
            {
                _calcMessage = "Please set Memo Date first.";
                _calcSuccess = false;
                return;
            }

            if (header.Details == null || !header.Details.Any())
            {
                _calcMessage = "No details to convert.";
                _calcSuccess = false;
                return;
            }

            var memoDateOnly = header.MemoDate.Date;
            var currencies = header.Details
                .Select(d => d.CurrencyPO?.Trim().ToUpper())
                .Where(c => !string.IsNullOrWhiteSpace(c) && !c.Equals("USD", StringComparison.OrdinalIgnoreCase))
                .Distinct()
                .ToList();

            if (!currencies.Any())
            {
                _calcMessage = "All currencies are already USD.";
                _calcSuccess = true;
                return;
            }

            var existingRates = await Db.PoExchangeRates
                .Where(r => currencies.Contains(r.PoCurrency)
                    && r.BaseCurrency == "USD"
                    && r.ExcDate.Date == memoDateOnly)
                .ToListAsync();

            var currenciesFromDb = existingRates.Select(r => r.PoCurrency).ToHashSet(StringComparer.OrdinalIgnoreCase);
            var currenciesToFetch = currencies.Where(c => !currenciesFromDb.Contains(c!)).ToList();

            ExchangeRateResponse? response = null;
            if (currenciesToFetch.Any())
            {
                DateTime memoDate = header.MemoDate.Date;
                DateTime now = DateTime.Now;
                DateTime combined = memoDate.AddHours(now.Hour).AddMinutes(now.Minute).AddSeconds(now.Second);
                DateTime utcDate = combined.ToUniversalTime();
                var dateStr = utcDate.ToString("yyyy-MM-dd");

                var appId = "e483ad469b1142d6aaccb2f472658efd";
                var apiUrl = $"api/historical/{dateStr}.json?app_id={appId}";

                try
                {
                    var httpClient = HttpClientFactory.CreateClient("ExchangeRateApi");
                    response = await httpClient.GetFromJsonAsync<ExchangeRateResponse>(apiUrl);
                }
                catch (Exception apiEx)
                {
                    _calcMessage = $"Failed to fetch exchange rates from API: {apiEx.Message}";
                    _calcSuccess = false;
                    return;
                }

                if (response == null || response.rates == null || !response.rates.Any())
                {
                    _calcMessage = "No exchange rates returned from API.";
                    _calcSuccess = false;
                    return;
                }
            }

            var exchangeRatesToSave = new List<PoExchangeRateModel>();
            var convertedCount = 0;
            var notFoundCurrencies = new List<string>();

            foreach (var currency in currencies)
            {
                if (string.IsNullOrEmpty(currency)) continue;
                
                decimal rate;
                var existingRate = existingRates.FirstOrDefault(r => r.PoCurrency.Equals(currency, StringComparison.OrdinalIgnoreCase));

                if (existingRate != null)
                {
                    rate = existingRate.ExcRate;
                }
                else if (response?.rates != null && response.rates.TryGetValue(currency, out var apiRate) && apiRate > 0)
                {
                    rate = apiRate;
                    exchangeRatesToSave.Add(new PoExchangeRateModel
                    {
                        PoCurrency = currency,
                        BaseCurrency = "USD",
                        ExcDate = header.MemoDate,
                        ExcRate = rate
                    });
                }
                else
                {
                    notFoundCurrencies.Add(currency);
                    continue;
                }

                var usdRate = 1m / rate;
                foreach (var detail in header.Details.Where(d =>
                    !string.IsNullOrWhiteSpace(d.CurrencyPO) &&
                    d.CurrencyPO.Trim().Equals(currency, StringComparison.OrdinalIgnoreCase)))
                {
                    detail.RatePO = Math.Round(detail.RatePO * usdRate, 6);
                    detail.CurrencyPO = "USD";
                    convertedCount++;
                }
            }

            if (exchangeRatesToSave.Any())
            {
                Db.PoExchangeRates.AddRange(exchangeRatesToSave);
                await Db.SaveChangesAsync();
            }

            if (notFoundCurrencies.Any())
            {
                _calcMessage = $"Converted {convertedCount} items. Rate not found for: {string.Join(", ", notFoundCurrencies)}";
                _calcSuccess = convertedCount > 0;
            }
            else if (convertedCount > 0)
            {
                _calcMessage = $"Successfully converted {convertedCount} item(s) to USD.";
                _calcSuccess = true;
            }
            else
            {
                _calcMessage = "No items were converted.";
                _calcSuccess = false;
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            _calcMessage = $"Error: {ex.Message}";
            _calcSuccess = false;
            Console.Error.WriteLine($"Error calculating USD: {ex.Message}");
        }
        finally
        {
            _calculating = false;
            StateHasChanged();
        }
    }

    private void Back() => Nav.NavigateTo("/memo-allocations");

    private async Task Save()
    {
        if (header == null) return;

        _saveMessage = string.Empty;
        _saveSuccess = false;

        try
        {
            await Db.SaveChangesAsync();
            _saveMessage = $"Memo Allocation {header.MemoNo} saved successfully.";
            _saveSuccess = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error saving memo allocation: {ex.Message}");
            _saveMessage = $"Error saving: {ex.Message}";
            _saveSuccess = false;
        }
    }

    private async Task Delete()
    {
        if (header == null) return;

        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Delete memo allocation {header.MemoNo}?");
        if (!confirmed) return;

        try
        {
            Db.MemoAllocations.Remove(header);
            await Db.SaveChangesAsync();
            Nav.NavigateTo("/memo-allocations");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error deleting memo allocation: {ex.Message}");
        }
    }

    private async Task Print()
    {
        await JS.InvokeVoidAsync("window.print");
    }

    private async Task WhApproval()
    {
        if (header == null || !_isWarehouse) return;

        var confirmed = await JS.InvokeAsync<bool>("confirm", "Approve as Warehouse?");
        if (!confirmed) return;

        try
        {
            header.WhApprovalStatus = true;
            header.WhApprovalDate = DateTime.Now;
            header.WhApprovalUserId = _currentUserId;
            header.WhApprovalUserName = _currentUserName;

            await Db.SaveChangesAsync();
            _saveMessage = "Warehouse approval saved successfully.";
            _saveSuccess = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error saving WH approval: {ex.Message}");
            _saveMessage = $"Error saving WH approval: {ex.Message}";
            _saveSuccess = false;
        }
    }

    private async Task QcApproval()
    {
        if (header == null || !_isQc) return;

        var confirmed = await JS.InvokeAsync<bool>("confirm", "Approve as QC?");
        if (!confirmed) return;

        try
        {
            header.QcApprovalStatus = true;
            header.QcApprovalDate = DateTime.Now;
            header.QcApprovalUserId = _currentUserId;
            header.QcApprovalUserName = _currentUserName;

            await Db.SaveChangesAsync();
            _saveMessage = "QC approval saved successfully.";
            _saveSuccess = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error saving QC approval: {ex.Message}");
            _saveMessage = $"Error saving QC approval: {ex.Message}";
            _saveSuccess = false;
        }
    }

    public class ExchangeRateResponse
    {
        public string? disclaimer { get; set; }
        public string? license { get; set; }
        public long timestamp { get; set; }
        public string? @base { get; set; }
        public Dictionary<string, decimal> rates { get; set; } = new();
    }
}
