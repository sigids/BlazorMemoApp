@page "/master/address"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin,User")]
@rendermode InteractiveServer
@using BlazorMemoApp.Models
@using Microsoft.EntityFrameworkCore
@using System.Data.Odbc
@using System.Text.RegularExpressions
@inject BlazorMemoApp.Data.ApplicationDbContext Db
@inject ILogger<AddressMaster> Logger

<h1>Address Master</h1>
<hr />

<div class="row mb-3">
    <div class="col-auto">
        <button class="btn btn-primary" @onclick="ShowAddForm">Add New Address</button>
    </div>
    <div class="col-auto">
        <button class="btn btn-info" @onclick="SyncFromSybase" disabled="@_syncing">
            <span class="bi bi-arrow-repeat"></span> @(_syncing ? "Synchronizing..." : "Synchronize")
        </button>
    </div>
    <div class="col-auto">
        <div class="input-group">
            <span class="input-group-text">Search</span>
            <input class="form-control" style="width:250px;" @bind="_searchText" @bind:event="oninput" placeholder="Name, Code, Country..." />
        </div>
    </div>
    <div class="col-auto">
        <select class="form-select" style="width:100px;" @bind="_pageSize" @bind:after="OnPageSizeChanged">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>
</div>

@if (!string.IsNullOrEmpty(_syncMessage))
{
    <div class="alert @(_syncSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
        @_syncMessage
        <button type="button" class="btn-close" @onclick="() => _syncMessage = string.Empty"></button>
    </div>
}

@if (showForm)
{
    <div class="card mb-4">
        <div class="card-header">
            @(editingAddress.Id == 0 ? "Add New Address" : "Edit Address")
        </div>
        <div class="card-body">
            <EditForm Model="editingAddress" OnValidSubmit="SaveAddress">
                <DataAnnotationsValidator />
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Name</label>
                        <InputText class="form-control" @bind-Value="editingAddress.Name" />
                        <ValidationMessage For="() => editingAddress.Name" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Name Abbr</label>
                        <InputText class="form-control" @bind-Value="editingAddress.NameAbbr" />
                        <ValidationMessage For="() => editingAddress.NameAbbr" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Code</label>
                        <InputText class="form-control" @bind-Value="editingAddress.Code" />
                        <ValidationMessage For="() => editingAddress.Code" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Country</label>
                        <InputText class="form-control" @bind-Value="editingAddress.Country" />
                        <ValidationMessage For="() => editingAddress.Country" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Type</label>
                        <InputSelect class="form-select" @bind-Value="editingAddress.Type">
                            <option value="">-- Select Type --</option>
                            <option value="B">Buyer</option>
                            <option value="S">Supplier</option>
                            <option value="BS">Buyer & Supplier</option>
                        </InputSelect>
                        <ValidationMessage For="() => editingAddress.Type" />
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                </div>
            </EditForm>
        </div>
    </div>
}

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Name Abbr</th>
            <th>Code</th>
            <th>Country</th>
            <th>Type</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var address in PagedData)
        {
            <tr>
                <td>@address.Id</td>
                <td>@address.Name</td>
                <td>@address.NameAbbr</td>
                <td>@address.Code</td>
                <td>@address.Country</td>
                <td>@GetTypeDisplay(address.Type)</td>
                <td>
                    <button class="btn btn-sm btn-warning" @onclick="() => EditAddress(address)">Edit</button>
                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteAddress(address)">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<div class="d-flex justify-content-between align-items-center">
    <div>Showing @(FilteredData.Any() ? (_currentPage - 1) * _pageSize + 1 : 0) - @(Math.Min(_currentPage * _pageSize, FilteredData.Count())) of @FilteredData.Count()</div>
    <nav>
        <ul class="pagination pagination-sm mb-0">
            <li class="page-item @(_currentPage == 1 ? "disabled" : "")">
                <a class="page-link" href="#" @onclick="PrevPage" @onclick:preventDefault>Prev</a>
            </li>
            @for (var p = 1; p <= Math.Min(TotalPages, 10); p++)
            {
                var page = p;
                <li class="page-item @(p == _currentPage ? "active" : "")">
                    <a class="page-link" href="#" @onclick="() => GotoPage(page)" @onclick:preventDefault>@p</a>
                </li>
            }
            @if (TotalPages > 10)
            {
                <li class="page-item disabled"><span class="page-link">...</span></li>
                <li class="page-item @(TotalPages == _currentPage ? "active" : "")">
                    <a class="page-link" href="#" @onclick="() => GotoPage(TotalPages)" @onclick:preventDefault>@TotalPages</a>
                </li>
            }
            <li class="page-item @(_currentPage == TotalPages ? "disabled" : "")">
                <a class="page-link" href="#" @onclick="NextPage" @onclick:preventDefault>Next</a>
            </li>
        </ul>
    </nav>
</div>

@code {
    private List<MemoAdressModel> addresses = new();
    private MemoAdressModel editingAddress = new();
    private bool showForm = false;
    private string _searchText = string.Empty;
    private int _pageSize = 10;
    private int _currentPage = 1;
    private bool _syncing = false;
    private string _syncMessage = string.Empty;
    private bool _syncSuccess = false;

    private const string CODE_PREFIX = "HO/";

    private IEnumerable<MemoAdressModel> FilteredData => string.IsNullOrWhiteSpace(_searchText)
        ? addresses
        : addresses.Where(a =>
            (a.Name ?? "").Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            (a.NameAbbr ?? "").Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            (a.Code ?? "").Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            (a.Country ?? "").Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            (a.Type ?? "").Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    private List<MemoAdressModel> PagedData => FilteredData.Skip((_currentPage - 1) * _pageSize).Take(_pageSize).ToList();
    private int TotalPages => Math.Max(1, (int)Math.Ceiling(FilteredData.Count() / (double)_pageSize));

    private void OnPageSizeChanged() => _currentPage = 1;
    private void PrevPage() { if (_currentPage > 1) _currentPage--; }
    private void NextPage() { if (_currentPage < TotalPages) _currentPage++; }
    private void GotoPage(int p) => _currentPage = Math.Clamp(p, 1, TotalPages);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        addresses = await Db.MemoAddresses.OrderBy(a => a.Name).ToListAsync();
    }

    private void ShowAddForm()
    {
        editingAddress = new MemoAdressModel();
        showForm = true;
    }

    private void EditAddress(MemoAdressModel address)
    {
        editingAddress = new MemoAdressModel
        {
            Id = address.Id,
            Name = address.Name,
            NameAbbr = address.NameAbbr,
            Code = address.Code,
            Country = address.Country,
            Type = address.Type
        };
        showForm = true;
    }

    private void CancelEdit()
    {
        showForm = false;
        editingAddress = new MemoAdressModel();
    }

    private async Task SaveAddress()
    {
        if (string.IsNullOrWhiteSpace(editingAddress.Name))
        {
            return;
        }

        if (editingAddress.Id == 0)
        {
            Db.MemoAddresses.Add(editingAddress);
        }
        else
        {
            var existing = await Db.MemoAddresses.FindAsync(editingAddress.Id);
            if (existing != null)
            {
                existing.Name = editingAddress.Name;
                existing.NameAbbr = editingAddress.NameAbbr;
                existing.Code = editingAddress.Code;
                existing.Country = editingAddress.Country;
                existing.Type = editingAddress.Type;
            }
        }

        await Db.SaveChangesAsync();
        await LoadData();
        CancelEdit();
    }

    private async Task DeleteAddress(MemoAdressModel address)
    {
        Db.MemoAddresses.Remove(address);
        await Db.SaveChangesAsync();
        await LoadData();
    }

    private string GetTypeDisplay(string type)
    {
        return type switch
        {
            "B" => "Buyer",
            "S" => "Supplier",
            "BS" => "Buyer & Supplier",
            _ => type
        };
    }

    private int ExtractNumericPart(string code)
    {
        if (string.IsNullOrEmpty(code) || !code.StartsWith(CODE_PREFIX))
            return 0;

        var numericPart = code.Substring(CODE_PREFIX.Length);
        var match = Regex.Match(numericPart, @"^\d+");
        if (match.Success && int.TryParse(match.Value, out int result))
            return result;
        return 0;
    }

    private async Task SyncFromSybase()
    {
        _syncing = true;
        _syncMessage = string.Empty;
        _syncSuccess = false;
        StateHasChanged();

        try
        {
            var maxLocalCode = addresses
                .Where(a => !string.IsNullOrEmpty(a.Code) && a.Code.StartsWith(CODE_PREFIX))
                .Select(a => ExtractNumericPart(a.Code))
                .DefaultIfEmpty(0)
                .Max();

            var existingCodes = addresses
                .Where(a => !string.IsNullOrEmpty(a.Code))
                .Select(a => a.Code)
                .ToHashSet(StringComparer.OrdinalIgnoreCase);

            var newRecords = new List<MemoAdressModel>();

            var connectionString = "DSN=Stage7;UID=sql;PWD=sql;";

            using var conn = new OdbcConnection(connectionString);
            await conn.OpenAsync();

            var query = @"SELECT add_name, add_name_abbr, add_code, add_country, add_type 
                          FROM dba.address 
                          WHERE add_code LIKE 'HO/%'";

            using var cmd = new OdbcCommand(query, conn);
            using var reader = await cmd.ExecuteReaderAsync();

            while (await reader.ReadAsync())
            {
                var addCode = reader.IsDBNull(2) ? "" : reader.GetString(2).Trim();
                
                if (string.IsNullOrEmpty(addCode) || !addCode.StartsWith(CODE_PREFIX))
                    continue;

                var numericPart = ExtractNumericPart(addCode);
                if (numericPart <= maxLocalCode)
                    continue;

                if (existingCodes.Contains(addCode))
                    continue;

                var newAddress = new MemoAdressModel
                {
                    Name = reader.IsDBNull(0) ? "" : reader.GetString(0).Trim(),
                    NameAbbr = reader.IsDBNull(1) ? "" : reader.GetString(1).Trim(),
                    Code = addCode,
                    Country = reader.IsDBNull(3) ? "" : reader.GetString(3).Trim(),
                    Type = reader.IsDBNull(4) ? "" : reader.GetString(4).Trim()
                };

                newRecords.Add(newAddress);
                existingCodes.Add(addCode);
            }

            conn.Close();

            if (newRecords.Count > 0)
            {
                Db.MemoAddresses.AddRange(newRecords);
                await Db.SaveChangesAsync();
                await LoadData();

                _syncSuccess = true;
                _syncMessage = $"Synchronization completed. Added {newRecords.Count} new record(s).";
            }
            else
            {
                _syncSuccess = true;
                _syncMessage = "Synchronization completed. No new records to add.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to sync addresses from Sybase");
            _syncSuccess = false;
            _syncMessage = $"Synchronization failed: {ex.Message}";
        }
        finally
        {
            _syncing = false;
            StateHasChanged();
        }
    }
}
