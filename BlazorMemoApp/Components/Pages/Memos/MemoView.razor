@page "/memos/{Id:int}"
@rendermode InteractiveServer
@using BlazorMemoApp.Models
@using Microsoft.EntityFrameworkCore
@using BlazorMemoApp.Components.Memos
@using System.Security.Claims
@inject BlazorMemoApp.Data.ApplicationDbContext Db
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider

<h1>Memo @header?.MemoNo</h1>

@if (header is null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row g-3">
        <div class="col-sm-2">
            <label class="form-label">Memo No</label>
            <input class="form-control" value="@header.MemoNo" disabled />
        </div>
        <div class="col-sm-2">
            <label class="form-label">Memo Date</label>
            <InputDate class="form-control" @bind-Value="header.MemoDate" />
        </div>
        <div class="col-sm-2">
            <label class="form-label">Buyer</label>
            <InputSelect class="form-select" @bind-Value="header.BuyerId">
                <option value="">-- Select --</option>
                @foreach (var buyer in buyers)
                {
                    <option value="@buyer.Id">@buyer.Name - @buyer.NameAbbr</option>
                }
            </InputSelect>
        </div>
        <div class="col-sm-2">
            <label class="form-label">Style</label>
            <InputSelect class="form-select" @bind-Value="header.StyleId" disabled="@(header.BuyerId == null)">
                <option value="">-- Select --</option>
                @foreach (var style in filteredStyles)
                {
                    <option value="@style.Id">@style.StyleName</option>
                }
            </InputSelect>
        </div>
        <div class="col-sm-2">
            <label class="form-label">Garment Qty</label>
            <InputNumber class="form-control" @bind-Value="header.GmtQty" />
        </div>
        <div class="col-sm-2">
            <label class="form-label">FOB Value</label>
            <InputNumber class="form-control" @bind-Value="header.GmtFobValue" />
        </div>
        <div class="col-sm-2">
            <label class="form-label">Supplier</label>
            <InputSelect class="form-select" @bind-Value="header.SupplierId">
                <option value="">-- Select --</option>
                @foreach (var supplier in suppliers)
                {
                    <option value="@supplier.Id">@supplier.Name - @supplier.NameAbbr</option>
                }
            </InputSelect>
        </div>

        <div class="col-sm-2">
            <label class="form-label">PO Selected</label>
            <input class="form-control" value="@header.PONumber" disabled />
        </div>
    </div>

    @* <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-sm-3"><label class="form-label">Memo No</label><div>@header.MemoNo</div></div>
                <div class="col-sm-3"><label class="form-label">Memo Date</label><div>@header.MemoDate.ToString("yyyy-MM-dd")</div></div>
                <div class="col-sm-3"><label class="form-label">PO Number</label><div>@header.PONumber</div></div>
                <div class="col-sm-3"><label class="form-label">GmtQty</label><div>@header.GmtQty</div></div>
            </div>
        </div>
    </div> *@

    <BlazorMemoApp.Components.Memos.MemoDetailGrid Items="header.Details" />

    <div class="mt-3 d-flex gap-2 align-items-center flex-wrap">
        <button class="btn btn-secondary" @onclick="Back">Back</button>
        <button class="btn btn-primary" @onclick="Save">Save</button>
        <button class="btn btn-outline-primary" @onclick="Print">Print / Save PDF</button>
        <AuthorizeView Roles="Admin,Supervisor">
            <Authorized>
                @if ((header.ApproveStatus ?? "") != "Approved")
                {
                    <button class="btn btn-success" title="Approve this memo" @onclick="Approve">Approve</button>
                }
                else
                {
                    <span class="badge bg-success">Approved @header.ApproveDate?.ToString("yyyy-MM-dd HH:mm")</span>
                }
            </Authorized>
        </AuthorizeView>
        <button class="btn btn-danger" @onclick="Delete">Delete</button>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }
    private MemoHeaderModel? header;
    
    private List<MemoAdressModel> buyers = new();
    private List<MemoAdressModel> suppliers = new();
    private List<BuyerStyleModel> styles = new();
    
    private IEnumerable<BuyerStyleModel> filteredStyles => 
        header?.BuyerId == null 
            ? Enumerable.Empty<BuyerStyleModel>() 
            : styles.Where(s => s.BuyerId == header.BuyerId);

    protected override async Task OnInitializedAsync()
    {
        header = await Db.Memos.Include(m => m.Details).FirstOrDefaultAsync(m => m.Id == Id);
        
        buyers = await Db.MemoAddresses.Where(a => a.Type.Contains("B")).ToListAsync();
        suppliers = await Db.MemoAddresses.Where(a => a.Type.Contains("V") || a.Type.Contains("F")).ToListAsync();
        styles = await Db.BuyerStyles.ToListAsync();
    }

    private void Back() => Nav.NavigateTo("/memos");

    private async Task Save()
    {
        try
        {
            await Db.SaveChangesAsync();
            await JS.InvokeVoidAsync("alert", "Saved");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error saving memo: {ex.Message}");
        }
    }

    private async Task Print()
    {
        // Use browser print dialog; user can choose Save as PDF
        await JS.InvokeVoidAsync("window.print");
    }

    private async Task Delete()
    {
        if (header == null) return;
        var ok = await JS.InvokeAsync<bool>("confirm", $"Delete memo {header.MemoNo} and all details?");
        if (!ok) return;

        try
        {
            Db.Memos.Remove(header);
            await Db.SaveChangesAsync();
            Nav.NavigateTo("/memos");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error deleting memo: {ex.Message}");
        }
    }

    private async Task Approve()
    {
        if (header == null) return;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user?.Identity?.IsAuthenticated != true) return;
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        try
        {
            header.ApproveStatus = "Approved";
            header.ApproveUserId = userId;
            header.ApproveDate = DateTime.UtcNow;

            await Db.SaveChangesAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error approving memo: {ex.Message}");
        }
    }
}
